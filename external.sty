% A package for rendering LaTeX code using a separate document
%
% (c) Michael D. Adams <https://michaeldadams.org>
%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory macros/latex/base/lppl.txt .
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{external}[2019/01/05 v0.1 Externally Rendered LaTeX]

\RequirePackage{extncode}

\RequirePackage{graphicx}
\RequirePackage{keyval}
\RequirePackage{kvoptions}
\RequirePackage{suffix}
\RequirePackage{pdftexcmds}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newlength{\external@top}
\newlength{\external@bottom}
\newlength{\external@left}
\newlength{\external@right}

% Default values for options
\setlength{\external@top}{1in}
\setlength{\external@bottom}{1in}
\setlength{\external@left}{1in}
\setlength{\external@right}{1in}

\define@key{external}{top}{\setlength{\external@top}{#1}}
\define@key{external}{bottom}{\setlength{\external@bottom}{#1}}
\define@key{external}{left}{\setlength{\external@left}{#1}}
\define@key{external}{right}{\setlength{\external@right}{#1}}

\ProcessKeyvalOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Globals
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Values set while reading a dimension file
\newlength{\external@TOP}
\newlength{\external@BOTTOM}
\newlength{\external@LEFT}
\newlength{\external@RIGHT}
\newlength{\external@WIDTH}
\newlength{\external@HEIGHT}
\newlength{\external@DEPTH}

% Stream that `\externalWrite` writes to
\newwrite\external@file

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% KEYS:
% - latex
% - options

% keys:
%  action
%  file
% - dim, tex, pdf

% - class
% - pagestyle
% - math
% - display math
% - margins

% TODO: option for what command to use for `pdflatex`
% TODO: document that arguments may need to use ##1 instead of #1
% TODO: options for extentions (e.g., .dim, .tex, .pdf)
% TODO: options for debugging
% TODO: options for class (e.g., article) (pagestyle?)
% TODO: options for math
% TODO: options for display math
% TODO: allow user code to change \baselinestretch
% TODO: check and error if files not exist
% TODO: argument to specify margins
% NOTE: If you want to include display math in `\external` use the incantation: \[ \external{$\displaystyle ...$} \]


% TODO: pre-savebox pre-usebox
% ARGS: filename preamble body
\newcommand{\ExternalWrite}[3]{%
  \typeout{Writing to external: \unexpanded{#1}}%
  % Write to file
  \immediate\openout\external@file=#1.tex%
  \immediate\write\external@file{\ExternalCode{#1.dim}{\documentclass{article}#2}{}{#3}{}}%
  \immediate\closeout\external@file
}

% TODO: use the `shellesc` package
% TODO: run options (e.g., -shell-escape)
\newcommand{\ExternalRun}[1]{%
  % Compile file
  \immediate\typeout{Running external: #1.tex}%
  \ifcase\pdfshellescape% TODO: use check from `shellesc` package
    \GenericError{}{You must enable "-shell-escape"}{}{}
  \or
  \or
    \GenericError{}{You must enable "-shell-escape"}{}{}
  \fi
  \immediate\write18{pdflatex -shell-escape -halt-on-error -interaction=batchmode #1.tex}%
  % TODO: check for errors
}

% TODO: includegraphics options
\newcommand{\ExternalRead}[1]{%
  % Load the dimentions of the symbol
  \input{#1.dim}%
  % Use \raisebox to model the symbol's depth
  \raisebox{-\external@DEPTH}{%
    % Due to trouble with including a space after a command, we cannot use:
    %   \includegraphics[trim=\the\external@left \the\external@bottom \the\external@right \the\external@top]{#1.pdf}
    % So, instead we indirect through another command
    \external@includegraphics{\the\external@LEFT}{\the\external@BOTTOM}{\the\external@RIGHT}{\the\external@TOP}{#1.pdf}}%
}

\newcommand{\external@includegraphics}[5]{\includegraphics[trim=#1 #2 #3 #4]{#5}}

\newcommand{\external}[4][]{\ExternalWrite{#2}{#3}{#4}\ExternalRun{#2}\ExternalRead{#2}}

% TODO: `file` is fully expanded, if we don't want part of it expanded, include that in an `\unexpanded`

% ARGS: name action preamble
\newcommand{\newexternal}[3]{
  % ARGS: file code
  \newcommand{#1}[2]{%
    #2%
    \edef\external@filename{{##1}}%
    \expandafter\external\external@filename{#3}{##2}}}

% ARGS: name action fileNameCmd preamble
\WithSuffix\newcommand{\newexternal}*[4]{%
  % ARGS: code
  \newcommand{#1}[1]{%
    #2%
    \edef\external@filename{{#3}}%
    \expandafter\external\external@filename{#4}{##1}}}

%\verbatiminput{...}
%\newcommand\xexternal[1]{%
%  \unexpanded{+++#1}%
%}

\endinput
%%
%% End of file `external.sty'.
