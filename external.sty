% A package for rendering LaTeX code using a separate document
%
% (c) Michael D. Adams <https://michaeldadams.org>
%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory macros/latex/base/lppl.txt .
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{external}[2019/01/05 v0.1 Externally Rendered LaTeX]

\RequirePackage{extncode}

\RequirePackage{graphicx}
\RequirePackage{keyval}
\RequirePackage{kvoptions}
\RequirePackage{suffix}
\RequirePackage{pdftexcmds}
\RequirePackage{shellesc}
\RequirePackage{ifpdf}
\RequirePackage{ifxetex}
\RequirePackage{ifluatex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\stringkey}[2]{%
  \expandafter\def\csname external@#1\endcsname{#2}%
  \define@key{external}{#1}{\expandafter\def\csname external@#1\endcsname{##1}}}

\newcommand{\lengthkey}[2]{%
  \expandafter\newlength\csname external@#1\endcsname%
  \expandafter\setlength\csname external@#1\endcsname{#2}%
  \define@key{external}{#1}{\expandafter\setlength\csname external@#1\endcsname{##1}}}

\stringkey{file}{}
\stringkey{file/dim}{.dim}
\stringkey{file/tex}{.tex}
\stringkey{file/pdf}{.pdf}

\stringkey{documentclass}{article} % empty = do not add documentclass
\stringkey{documentclass/options}{}
\stringkey{preamble}{}
\stringkey{pre-savebox}{}
\stringkey{pre-usebox}{}

\stringkey{math}{false}
\def\external@math@false{false}
\def\external@math@true{true}
\def\external@math@inline{inline}
\def\external@math@display{display}

\stringkey{latex}{} % blank = auto
\stringkey{latex/options}{-halt-on-error -interaction=batchmode}

\lengthkey{top}{1in}
\lengthkey{bottom}{1in}
\lengthkey{left}{1in}
\lengthkey{right}{1in}

\stringkey{includegraphics/options}{}

% keys:
% - expand

% TODO: extncode.sty -> external.code.sty

\ProcessKeyvalOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Globals
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Values set while reading a dimension file
\newlength{\external@TOP}
\newlength{\external@BOTTOM}
\newlength{\external@LEFT}
\newlength{\external@RIGHT}
\newlength{\external@WIDTH}
\newlength{\external@HEIGHT}
\newlength{\external@DEPTH}

% Stream that `\externalWrite` writes to
\newwrite\external@filehandle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Low-level Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%% \ExternalWrite

% ARGS: options body
\newcommand{\ExternalWrite}[2][]{{\setkeys{external}{#1}\ExternalWrite@{#2}}}
% ARGS: body
\newcommand{\ExternalWrite@}[1]{%
  % Error checking
  \ifx\empty\external@file
    \PackageError{external}{In \noexpand\ExternalWrite, no output TeX file specified}{}%
  \fi
  % Handling `math` option
  \ifx     \external@math@false  \external@math\def\external@body{#1}%
  \else\ifx\external@math@true   \external@math\def\external@body{$#1$}%
  \else\ifx\external@math@inline \external@math\def\external@body{$#1$}%
  \else\ifx\external@math@display\external@math\def\external@body{$\displaystyle#1$}%
  \else\PackageError{external}{In \noexpand\ExternalRead,
    unknown math option (must be "true", "false", "inline", or "display"):
    \external@math}{}%
  \fi\fi\fi\fi
  % Use \edef to control what to expand in the arguments of \ExternalCode
  \edef\external@code{%
    \unexpanded{\ExternalCode}%
    {\external@file.dim}%
    {\unexpanded{\expandafter\setlength\csname external@TOP\endcsname}{\the\external@top}%
     \unexpanded{\expandafter\setlength\csname external@BOTTOM\endcsname}{\the\external@bottom}%
     \unexpanded{\expandafter\setlength\csname external@LEFT\endcsname}{\the\external@left}%
     \unexpanded{\expandafter\setlength\csname external@RIGHT\endcsname}{\the\external@right}%
     \ifx\empty\external@documentclass
     \else
       \unexpanded{\documentclass}%
       [\csname external@documentclass/options\endcsname]%
       {\external@documentclass}%
     \fi
     \expandafter\unexpanded\expandafter{\external@preamble}}%
    {\csname external@pre-savebox\endcsname}%
    {\expandafter\unexpanded\expandafter{\external@body}}%
    {\csname external@pre-usebox\endcsname}}%
  %%%% Core code
  \immediate\openout\external@filehandle="\external@file\csname external@file/tex\endcsname"%
  \immediate\write\external@filehandle{\external@code}%
  \immediate\closeout\external@filehandle
  %%%% End core code
  % Sanity checking (warnings)
  \IfFileExists{\external@file\csname external@file/tex\endcsname}
    {}
    {\PackageWarning{external}{In \noexpand\ExternalWrite, output TeX file does not exist:
        \external@file\csname external@file/tex\endcsname}}%
}

%%%%%%%% \ExternalRun

% ARGS: options
\newcommand{\ExternalRun}[1][]{{\setkeys{external}{#1}\ExternalRun@}}
\newcommand{\ExternalRun@}{{%
  % Error checking
  \ifx\empty\external@file
    \PackageError{external}{In \noexpand\ExternalRun, no input TeX file specified}{}%
  \fi
  \ifcase\pdfshellescape
    \PackageError{external}{In \noexpand\ExternalRun,
      shell escape (i.e., \noexpand\write18) not enabled.
      Maybe add `-shell-escape` to the command line options}{}%
  \or
  \or
    \PackageError{external}{In \noexpand\ExternalRun,
      shell escape (i.e., \noexpand\write18) not enabled.
      Maybe add `-shell-escape` to the command line options}{}%
  \fi
  \IfFileExists{\external@file\csname external@file/tex\endcsname}
    {}
    {\PackageError{external}{In \noexpand\ExternalRun, input TeX file does not exist:
        \external@file\csname external@file/tex\endcsname}{}}%
  % Determine what latex command to use
  \ifx\empty\external@latex
    \ifluatex     \def\external@latexcmd{lualatex}%
    \else\ifxetex \def\external@latexcmd{xelatex}%
    \else\ifpdf   \def\external@latexcmd{pdflatex}%
    \else\PackageError{external}{In \noexpand\ExternalRun,
      could not detect the latex command to use.
      Use the `latex` option to explicitly specify it}{}%
    \fi\fi\fi
  \else
    \let\external@latexcmd{\external@latex}
  \fi
  %%%% Core code
  \ShellEscape{\external@latexcmd\space
    \csname external@latex/options\endcsname\space%
    \external@file\csname external@file/tex\endcsname}%
  %%%% End core code
  % Sanity checking (warnings)
  \IfFileExists{\external@file\csname external@file/pdf\endcsname}
    {}
    {\PackageWarning{external}{In \noexpand\ExternalRun, output PDF file does not exist:
        \external@file\csname external@file/pdf\endcsname}}%
  \IfFileExists{\external@file\csname external@file/dim\endcsname}
    {}
    {\PackageWarning{external}{In \noexpand\ExternalRun, output dimension file does not exist:
        \external@file\csname external@file/dim\endcsname}}%
}}

%%%%%%%% \ExternalRead

% ARGS: options
\newcommand{\ExternalRead}[1][]{{\setkeys{external}{#1}\ExternalRead@}}
\newcommand{\ExternalRead@}{%
  % Handling the `math` option
  \ifx     \external@math@false  \external@math\ExternalRead@@
  \else\ifx\external@math@true   \external@math\ExternalRead@@
  \else\ifx\external@math@inline \external@math\ExternalRead@@
  \else\ifx\external@math@display\external@math\[\ExternalRead@@\]
  \else\PackageError{external}{In \noexpand\ExternalRead,
    unknown math option (must be "true", "false", "inline", or "display"):
    \external@math}{}%
  \fi\fi\fi\fi}
\newcommand{\ExternalRead@@}{%
  % Error checking
  \ifx\empty\external@file
    \PackageError{external}{In \ExternalRead, no input PDF file specified}{}%
  \fi
  \IfFileExists{\external@file\csname external@file/pdf\endcsname}
    {}
    {\PackageError{external}{In \noexpand\ExternalRead, input PDF file does not exist:
        \external@file\csname external@file/pdf\endcsname}{}}%
  \IfFileExists{\external@file\csname external@file/dim\endcsname}
    {}
    {\PackageError{external}{In \noexpand\ExternalRun, input dimension file does not exist:
        \external@file\csname external@file/dim\endcsname}{}}%
  %%%% Core code
  \input{\external@file.dim}% Load the dimensions of the symbol
  \raisebox{-\external@DEPTH}{% Use \raisebox to model the symbol's depth
    % Due to trouble with including a space after a command, we cannot use:
    %
    %   \includegraphics[
    %     trim=\the\external@left \the\external@bottom
    %          \the\external@right \the\external@top]{#1.pdf}
    %
    % So, instead we indirect through another command.
    %
    % Also we need to expand \external@includegraphics/options before
    % \includegraphics parses its argument.
    \expandafter\let\expandafter\external@includegraphicsoptions
      \csname external@includegraphics/options\endcsname
    \expandafter\external@includegraphics
      \expandafter{\external@includegraphicsoptions}
      {\the\external@LEFT}
      {\the\external@BOTTOM}
      {\the\external@RIGHT}
      {\the\external@TOP}
      {\external@file.pdf}}%
  %%%% End core code
}

\newcommand{\external@includegraphics}[6]{\includegraphics[trim=#2 #3 #4 #5,#1]{#6}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% High-level Commands
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%% \external

% ARGS: options body
\newcommand{\external}[2][]{{%
  \setkeys{external}{#1}%
  \ExternalWrite@{#2}%
  \ExternalRun@%
  \ExternalRead@}}

%%%%%%%% \newexternal

% ARGS: options name pre-action post-action
\newcommand{\newexternal}[4][]{
  % ARGS: options body
  \newcommand{#2}[2][]{%
    #3%
    \external[#1,##1]{##2}%
    #4}}

%%%%%%%% \externalkeys

\newcommand{\externalkeys}[1]{\setkeys{external}{#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\endinput
%%
%% End of file `external.sty'.
