% A package for rendering LaTeX code using a separate document
%
% (c) Michael D. Adams <https://michaeldadams.org>
%
%% This program can be redistributed and/or modified under the terms
%% of the LaTeX Project Public License Distributed from CTAN archives
%% in directory macros/latex/base/lppl.txt .
%
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{external}[2019/01/05 v0.1 Externally Rendered LaTeX]

\RequirePackage{extncode}

\RequirePackage{graphicx}
\RequirePackage{keyval}
\RequirePackage{kvoptions}
\RequirePackage{suffix}
\RequirePackage{pdftexcmds}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Options
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\stringkey}[2]{\expandafter\def\csname external@#1\endcsname{#2}\define@key{external}{#1}{\expandafter\def\csname external@#1\endcsname{##1}}}

\stringkey{file}{}\let\external@file\empty
\stringkey{latex}{auto}
\stringkey{preamble}{} % TODO: wrap?
\stringkey{pre-savebox}{}
\stringkey{pre-usebox}{}

\stringkey{dimention-extention}{dim}
\stringkey{tex-extension}{tex}
\stringkey{pdf-extension}{pdf}

\newcommand{\lengthkey}[2]{\expandafter\newlength\csname external@#1\endcsname\expandafter\setlength\csname external@#1\endcsname{#2}\define@key{external}{#1}{\expandafter\setlength\csname external@#1\endcsname{##1}}}

% - margins
\lengthkey{top}{1in}
\lengthkey{bottom}{1in}
\lengthkey{left}{1in}
\lengthkey{right}{1in}

\stringkey{math}{false} % true, inline, display
\stringkey{documentclass}{article} % empty
\stringkey{documentclass-options}{}

% keys:
% - action
% - preamble
% - expand

% TODO: extncode.sty -> external.code.sty

\ProcessKeyvalOptions*

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Globals
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Values set while reading a dimension file
\newlength{\external@TOP}
\newlength{\external@BOTTOM}
\newlength{\external@LEFT}
\newlength{\external@RIGHT}
\newlength{\external@WIDTH}
\newlength{\external@HEIGHT}
\newlength{\external@DEPTH}

% Stream that `\externalWrite` writes to
\newwrite\external@filehandle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% TODO: document that arguments may need to use ##1 instead of #1
% TODO: options for debugging
% TODO: options for class (e.g., article) (pagestyle?)
% TODO: options for math
% TODO: options for display math
% TODO: allow user code to change \baselinestretch
% TODO: check and error if files not exist
% TODO: argument to specify margins
% NOTE: If you want to include display math in `\external` use the incantation: \[ \external{$\displaystyle ...$} \]


% TODO: filename pre-savebox pre-usebox
% ARGS: filename preamble body
\newcommand{\ExternalWrite}[3][]{\setkeys{external}{#1}\ExternalWrite@{#2}{}{#3}{}}

\newcommand{\ExternalWrite@}[4]{%
%\show{\external@file}
%\immediate\GenericError{}{No file specified in ExternalWrite}
  \ifx\external@file\empty
    \GenericError{}{No file specified in {ExternalWrite}}{}{}
  \else
  \fi
  % Write to file
  \immediate\openout\external@filehandle="\external@file.tex"%
  \edef\external@code{%
    \unexpanded{\ExternalCode}%
    {\external@file.dim}%
    {\unexpanded{\expandafter\setlength\csname external@TOP\endcsname}{\the\external@top}%
     \unexpanded{\expandafter\setlength\csname external@BOTTOM\endcsname}{\the\external@bottom}%
     \unexpanded{\expandafter\setlength\csname external@LEFT\endcsname}{\the\external@left}%
     \unexpanded{\expandafter\setlength\csname external@RIGHT\endcsname}{\the\external@right}%
     \unexpanded{\documentclass{article}}%
     \unexpanded{#1}}%
    \unexpanded{{#2}}%
    \unexpanded{{#3}}%
    \unexpanded{{#4}}}%
  \immediate\write\external@filehandle{\external@code}%
  \immediate\closeout\external@filehandle
}

% TODO: use the `shellesc` package
% TODO: run options (e.g., -shell-escape)
\newcommand{\ExternalRun}[1][]{\setkeys{external}{#1}\ExternalRun@}
\newcommand{\ExternalRun@}{%
  % Compile file
  \ifx\external@file\empty
    \GenericError{}{No file specified in {ExternalRun}}{}{}
  \else
  \fi
  \immediate\typeout{Running external: \external@file}%
  \ifcase\pdfshellescape% TODO: use check from `shellesc` package
    \GenericError{}{You must enable "-shell-escape"}{}{}
  \or
  \or
    \GenericError{}{You must enable "-shell-escape"}{}{}
    \fi
  \immediate\write18{pdflatex -shell-escape -halt-on-error -interaction=batchmode \external@file.tex}%
  % TODO: check for errors
}

% TODO: includegraphics options
\newcommand{\ExternalRead}[1][]{\setkeys{external}{#1}\ExternalRead@{}}
\newcommand{\ExternalRead@}{%
  % Load the dimentions of the symbol
  \input{\external@file.dim}%
  % Use \raisebox to model the symbol's depth
  \raisebox{-\external@DEPTH}{%
    % Due to trouble with including a space after a command, we cannot use:
    %   \includegraphics[trim=\the\external@left \the\external@bottom \the\external@right \the\external@top]{#1.pdf}
    % So, instead we indirect through another command
    \external@includegraphics{\the\external@LEFT}{\the\external@BOTTOM}{\the\external@RIGHT}{\the\external@TOP}{\external@file.pdf}}%
}

\newcommand{\external@includegraphics}[5]{\includegraphics[trim=#1 #2 #3 #4]{#5}}

\newcommand{\external}[3][]{%
  \setkeys{external}{#1}%
  \ExternalWrite@{#2}{}{#3}{}%
  \ExternalRun@%
  \ExternalRead@}

\newcommand{\externaltest}[4][]{\expandafter\setlength\csname external@top\endcsname{2in}\external[#1]{#2}{#3}{#4}}

\newcommand{\mathexternal}[4][]{\external[#1]{#2}{#3}{$#4$}}

% TODO: `file` is fully expanded, if we don't want part of it expanded, include that in an `\unexpanded`

% ARGS: name action preamble
\newcommand{\newexternal}[3]{
  % ARGS: file code
  \newcommand{#1}[2]{%
    #2%
    \external[file=##1]{#3}{##2}}}

% ARGS: name action fileNameCmd preamble
\WithSuffix\newcommand{\newexternal}*[4]{%
  % ARGS: code
  \newcommand{#1}[1]{%
    #2%
    \external[file=#3]{#4}{##1}}}

%\verbatiminput{...}
%\newcommand\xexternal[1]{%
%  \unexpanded{+++#1}%
%}

\endinput
%%
%% End of file `external.sty'.
