%% locpream.tex - Local preambles within LaTeX documents
%%
%% This file contains the documentation for the `locpream` package
%%
%% Copyright 2019 by Michael D. Adams
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Michael D. Adams.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\documentclass[10pt]{ltxdoc}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Packages and package settings

\usepackage{xkeyval} % Required by `changelog`
\usepackage{xparse} % Required by `changelog`
\usepackage[color]{changelog} % For the `changelog` environment

\usepackage{noindentafter} % For the `\NoIndentAfterThis` command

\usepackage{tcolorbox}
\tcbuselibrary{listings}
\tcbuselibrary{documentation}
\tcbset{
  % Keep indentation working normally inside `docCommand` and friends
  before doc body={\parindent=15pt\NoIndentAfterThis},
  % Use the default `dispExample` formatting except don't mess with the font size
  docexample/.style={colframe=ExampleFrame,colback=ExampleBack,
    before skip=\medskipamount,after skip=\medskipamount}}

\usepackage{xurl} % Allow url to line break anywhere

%%%%%%%%%%%%%%%%%%%%
% The current package
\usepackage{locpream}
%\locpreamkeys{debug=true}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Customization

% Use alternate symbols for list items
\def\labelitemi{\normalfont\bfseries{--}}
\def\labelitemii{\(\ast\)}
\def\labelitemiii{\(\cdot\)}
\def\labelitemiv{\(\bullet\)}

% Enable creating the index
\makeindex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Command definitions

\newcommand{\com}[1]{\refCom{#1}}\newcommand{\Com}[1]{\cs{#1}}
\newcommand{\env}[1]{\refEnv{#1}}\newcommand{\Env}[1]{\texttt{#1}}
\newcommand{\key}[1]{\refKey{#1}}\newcommand{\Key}[1]{\texttt{#1}}

\newcommand{\pkg}[1]{\href{https://ctan.org/pkg/#1}{\texttt{#1}}}
\newcommand{\Pkg}[1]{\texttt{#1}}

\newcommand{\showfile}[1]{
  \begin{tcolorbox}[title=\texttt{#1},right=4pt]
  \verbatiminput{#1}
  \end{tcolorbox}
}

\newcommand{\sx}{%
  \rule{2pt}{4.5pt}%
  \llap{\rule[5.5pt]{2pt}{1.5pt}}%
  \llap{\rule[8pt]{2pt}{2pt}}%
}

\catcode`\<=\active
\catcode`\>=\active

\newcommand<{%
  \rule[5.5pt]{4pt}{1.5pt}%
  \llap{\sx}}
\newcommand>{%
  \rlap{\sx}%
  \rule[5.5pt]{4pt}{1.5pt}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{document}

\GetFileInfo{locpream.sty} % For `\fileversion` and `\filedate`

\title{The \textsf{locpream} package:\\
  Local preambles within \LaTeX\ documents%
    \thanks{This document corresponds to
      \textsf{locpream}~\fileversion, dated \filedate.}}
\author{Michael D. Adams\\\url{https://michaeldadams.org}}
\date{}
\maketitle

\begin{abstract}
\noindent
The \Pkg{locpream} package allows the use of preambles that are local
to specific parts of a document.
This is useful for using symbols from packages without loading those
packages into the main document.
For example, \Pkg{locpream} allows the simultaneous use of symbols from
packages that conflict with each other or otherwise cannot be loaded
together.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}%
\label{sec:Introduction}

The \Pkg{locpream} package allows the use of preambles that are local
to specific parts of a document.
For example, you may want to use symbols from packages that cannot be
loaded at the same time.
By compiling them in separate documents and then inserting their
compiled results into a master document, \Pkg{locpream} allows you to
use these symbols without conflicts.

This document serves as both the documentation and test suite for the
\Pkg{locpream} package, so some examples in this document are for
testing not just documentation.

\begin{tcolorbox}[title=Warning,colback=red!5!white,colframe=red!75!black]
This package is pre-alpha, and its interface may change without notice.
\end{tcolorbox}

TODO:\marginpar{TODO}
See Section~\ref{sec:Options} more details about options and
Section~\ref{sec:Issues and Workarounds} for common issues and their
workarounds.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Quick Start}%
\label{subsec:Quick Start}

Suppose you want to use the \Com{textbeta} symbol from the
\pkg{textgreek} package, but you do not want to load the
\pkg{textgreek} package into your document.
Maybe it is incompatible with some other package that you use or maybe
\LaTeX\ has run out of space for declaring new fonts.
You can render \Com{textbeta} using the \com{localpreamble} command as
follows.

\begin{dispExample}
An atom undergoing
\localpreamble[preamble={\usepackage{textgreek}}]{\textbeta-decay}
can emit an electron.
\end{dispExample}

\noindent
If you prefer, you can also use the environment \env{localpreambleenv}
as follows.

\begin{dispExample}
An atom undergoing
\begin{localpreambleenv}[preamble={\usepackage{textgreek}}]
  \textbeta-decay
\end{localpreambleenv}
~can emit an electron.
\end{dispExample}

\noindent
The only difference between \com{localpreamble} and
\env{localpreambleenv} is that one is a command and the other is an
environment.

If you want to format the \LaTeX\ code as ``display'' math, use the
|math=display| option as follows.

\begin{dispExample}
The solution to the two-dimensional integral
\localpreamble[preamble={\usepackage{amsmath}}, math=display]
  {\iint xy\,dx\,dy}
involves $x^2$ and $y^2$.
\end{dispExample}

Note that even though these examples are compiled as separate
\LaTeX\ documents, they are automatically properly spaced relative to
the surrounding text.
In the resulting PDF, they even behave properly with regard to
search, text selection, and copy-and-paste.

For example, in the following, it is impossible to tell the difference
between the ``y'' generated from \com{localpreamble} and the one that
is not.
(This even handles the descender on the ``y''.)

\begin{dispExample}
x\localpreamble{y}z xyz
\end{dispExample}

However, there is a limitation to this when it comes to kerning and
ligatures.
For example, in the following, due to kerning, ``T'' and ``e'' have a
different amount of space between them when using \com{localpreamble}
and when not, and putting the second ``f'' in \com{localpreamble}
breaks up the ``ffi'' ligature.

\begin{dispExample}
Teffi T\localpreamble{e}f\localpreamble{f}i
\end{dispExample}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Notation}%
\label{subsec:Notation}

For testing purposes, this documentation surrounds most examples with
|<| and |>|, which are customized to render as < and >.
These are used as gauges/registration marks.
They make it easy to see whether there is extra space to the left or
right of a symbol and whether parts of the symbol extend below the
baseline.
The bottom of the bottom bar is at the baseline.
The top of the top, middle and bottom bars are at the font
size~(10~points), the top of an ``M''~(7~points), and the top of an
``x''~(4.5~points), respectively.
This is demonstrated in the following example.

\begin{dispExample}
<\rule{2pt}{10pt}> <\rule{2pt}{7pt}> <\rule{2pt}{4.5pt}> <M> <x> <>
\end{dispExample}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Related Packages}%
\label{subsec:Related Packages}

There are a number of packages that provide similar functionality to
that of \Pkg{locpream}.
The main distinguishing features of \Pkg{locpream} are that it allows
locally specified preambles and that it does exact spacing and sizing.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Externalization}

A number of packages allow specified parts of a document to be
``externalized'' by compiling those parts as a separate
\LaTeX\ documents and then including the result in the master document.
However, none of these allow those document parts to have a local
preamble.

\paragraph{\pkg{tikz}}

Contains an |external| library, which caches the results of compiling
each \Env{tikzpicture} in order to improve later compilation times.
Has no support for those pictures having different preambles from the
main document.

\paragraph{\pkg{pgfplots}}

Contains an |external| library similar to the \pkg{tikz} |external|
library.

\paragraph{\pkg{preview}}

Allows extracting certain environments from \LaTeX\ sources as
graphics.
Intended for rendering ``preview'' versions of parts of a document and
used as part of \pkg{preview-latex} and AUC\TeX.
Does not support custom preambles or exact spacing.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Miniature Documents}

\paragraph{\pkg{minidocument}}

Provides the \Env{minidocument} environment, which allows an entire
miniature document to be embedded including a separate
\Com{documentclass} and preamble.
However, assumes documents are entire pages and does not support exact
spacing.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Ignoring Preambles}%
\label{subsec:Ignoring Preambles}

Several packages allow sub-documents to be included in a master
document.
These sub-documents are full-fledged \LaTeX\ documents that can be
compiled on their own, but when they are included in the master
document, either their preamble or specified parts are ignored.
These packages are geared towards helping authors manage large
documents that otherwise take a long time to compile~(e.g.,~a book with
each chapter as a sub-document).
When compiling the master document, these packages do not compile the
sub-documents separately.
Thus, they do not support local preambles when compiling the master
document.

\paragraph{\pkg{docmute}}

Redefines \Com{input} and \Com{include} to ignore everything between
the initial \Com{documentclass} and \Com{begin\{document\}}.

\paragraph{\pkg{includex}}

Defines versions of \Com{include} that ignore certain parts of the
included document.
Not only can it ignore everything between \Com{documentclass} and
\Com{begin\{document\}}, but it also allows ignoring anything outside
specified environments.
The documentation for this package says that it is currently
unsupported.

\paragraph{\pkg{newclude}}

Adds various features to the \LaTeX\ inclusion system.
One of those features is the ability to ignore anything outside
specified environments.
The documentation for this package says that it is intended to subsume
the features of \pkg{includex}, but it also marks these features as in
development.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Copying Preambles from Master Files}

Another approach to sub-documents is to have those sub-documents
automatically copy the preamble of the master file.
As with the packages in Section~\ref{subsec:Ignoring Preambles}, these
packages are geared towards helping authors manage large documents that
otherwise take a long time to compile (e.g., a book with each chapter
as a sub-document).
When compiling the master document, these packages do not compile the
sub-documents separately.
Thus, they do not support local preambles when compiling the master
document.

\paragraph{\pkg{subfiles}}

Defines a document class for sub-documents that automatically copies
the preamble of the master document when the sub-document is compiled,
but when the master document is compiled, everything outside the
\Env{document} environment is ignored.

\paragraph{\pkg{childdoc}}

Defines commands to be put in sub-documents instead of the standard
\Com{documentclass} and preamble.
When the sub-document is separately compiled, this automatically copies
the preamble of the master document, but when the master document is
compiled, the commands are ignored.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Including Entire Pages}

Some packages are designed to allow completely separate documents to be
combined into one document (e.g., combining multiple articles into a
proceedings).
Each document has its own preamble, but documents are included a whole
page at a time.

\paragraph{\pkg{combine}}

Allows assembling a group of individual \LaTeX\ documents into a single
document.
Also includes the \Pkg{combinet} and \Pkg{combnat} package to allow
documents to share things like the table of contents.

\paragraph{\pkg{subdocs}}

Allows combining documents where each sub-document is a complete,
normal \LaTeX\ document that is typeset separately.
Shares the |.aux| files between documents so thing like the table of
contents can be kept in common.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Listing Code and Displaying the Results}

\paragraph{\pkg{tcolorbox}, \pkg{example}, \pkg{examplep}, \pkg{latexdemo}, and \pkg{showexpl}}

These packages all provide environments that display their content as
source code next to the result of rendering that code.
None of these involve separate compilation or allow for specifying a
local preamble.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Minimal Page Layouts}

\paragraph{\pkg{standalone}}

Provides the document class |standalone| that produces a page with
minimal layout that is sized to fit its contents.
Does not support automatic extraction of standalone documents, and has
no support for exact spacing or including the results of compiling a
standalone document.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{High-level Commands}%
\label{sec:High-level Commands}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\Com{localpreamble} and \Env{localpreambleenv}}%
\label{subsec:localpreamble and localpreambleenv}

The main commands of this package are \Com{localpreamble} and
\Env{localpreambleenv}.

\begin{docCommand}{localpreamble}{\oarg{options}\marg{code}}

Externally compiles the \LaTeX\ code in \meta{code} and then includes
the result with exact spacing.
This allows \meta{code} to have its own preamble.
An example of this is the following.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{amsmath}}, math=inline]
   {\iint xy\,dx\,dy}>
\end{dispExample}
\end{docCommand}

\begin{docEnvironment}{localpreambleenv}{\oarg{options}}

The same as \com{localpreamble}.
The only difference between the two is that \com{localpreamble} is a
command and \Env{localpreambleenv} is an environment.
An example of this is the following.

\begin{dispExample}
<\begin{localpreambleenv}[preamble={\usepackage{amsmath}}, math=inline]
   \iint xy\,dx\,dy
 \end{localpreambleenv}>
\end{dispExample}
\end{docEnvironment}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\Com{newlocalpreamble} and \Com{newlocalpreambleenv}}%
\label{subsec:newlocalpreamble and newlocalpreambleenv}

It is sometimes useful to define versions of the \com{localpreamble}
command and the \env{localpreambleenv} environment that have customized
default values for their options.
For example, you might want to define versions that load the
\pkg{amsmath} package by default.
These can be created with \Com{newlocalpreamble} and
\Com{newlocalpreambleenv}.

\begin{docCommand}{newlocalpreamble}{\oarg{options}\marg{command name}}

With \Com{newlocalpreamble}, one can define a version of
\com{localpreamble} that has customized default values for its options
as seen in the following example.

\begin{dispExample}
<\newlocalpreamble[preamble={\usepackage{amsmath}}, math=inline]{\ams}>
<\ams{\iint xy\,dx\,dy}>
<\ams[math=false]{$\iint xyzw\,dx\,dy$}>
\end{dispExample}
\end{docCommand}

\begin{docCommand}{newlocalpreambleenv}{\oarg{options}\marg{command name}}

With \Com{newlocalpreambleenv}, one can define a version of
\env{localpreambleenv} that has customized default values for its
options as seen in the following example.

\begin{dispExample}
<\newlocalpreambleenv[preamble={\usepackage{amsmath}}, math=inline]
   {amsenv}>
<\begin{amsenv}\iint xy\,dx\,dy\end{amsenv}>
<\begin{amsenv}[math=false]$\iint xyzw\,dx\,dy$\end{amsenv}>
\end{dispExample}
\end{docCommand}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Low-level Commands}%
\label{sec:Low-level Commands}

\begin{docCommand}{LocalPreambleWrite}{\oarg{options}\marg{body}}\end{docCommand}

\begin{docCommand}{LocalPreambleCompile}{\oarg{options}}\end{docCommand}

\begin{docCommand}{LocalPreambleRead}{\oarg{options}}

Both the \com{localpreamble} command and the \env{localpreambleenv}
environment contain three phases:
\begin{enumerate}
\item writing the intermediate \LaTeX\ file,
\item compiling the intermediate \LaTeX\ file, and
\item reading the file (typically a PDF) that results from that
  compilation.
\end{enumerate}
These are handled by \Com{LocalPreambleWrite},
\Com{LocalPreambleCompile}, and \Com{LocalPreambleRead}, respectively.
For example, instead of using the command \com{localpreamble}, you
could explicitly call each of these as in the following.

\begin{dispExample}
<\LocalPreambleWrite[file=locpream-locpream-separate,
                     preamble={\usepackage{amsmath}}]
   {$\iint xy\,dx\,dy$}>
<\LocalPreambleCompile[file=locpream-locpream-separate]>
<\LocalPreambleRead[file=locpream-locpream-separate]>
\end{dispExample}

Taking explicit control of these is particularly useful if you want to
cache compilation results.
See the \com{LocalPreambleCode} command for an example of this.
\end{docCommand}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{docCommand}{LocalPreambleCode}{%
  \marg{dimension~file}\marg{preamble}\marg{before~savebox}\marg{body}\\
  \phantom{\texttt{\textbackslash LocalPreambleCode}}%
  \marg{after~savebox}\marg{before~usebox}\marg{after~usebox}}

This command expands to the code used in the intermediate \LaTeX\ file.
It is useful if you want to store the \LaTeX\ code to be compiled in a
separate file and reuse the compiled results between compilations of
the master \LaTeX\ file.

The \meta{dimension file} is the full filename of the dimension file to
be generated.
The \meta{body} is the \LaTeX\ code to be compiled.
The \meta{preamble}, \meta{before savebox}, \meta{after savebox},
\meta{before usebox}, and \meta{after usebox} are the same as the
corresponding options in Section~\ref{sec:Options}.

For example, you might write the following file.

\showfile{locpream-standalone-simple.tex}

Then, in your master file you can compile and read that file with the
following commands.

\begin{dispExample}
<\LocalPreambleCompile[file=locpream-standalone-simple]>
<\LocalPreambleRead[file=locpream-standalone-simple]>
\end{dispExample}

Be careful if you rename such a file, as you will need to change the
\meta{dimension file} argument to match.
Otherwise, you will get an error along the lines of:

|In \LocalPreambleRead, input dimension file does not exist|

Also note that \Com{LocalPreambleCode} is defined in the
\Pkg{locpream.code} package.
This package is imported by the main \Pkg{locpream} package, so you do
not need to import it separately.
However, \Pkg{locpream.code} is designed be minimal and has no
dependencies.
Thus in the previous example, using the command
|\RequirePackage{locpream.code}| instead of the command
|\RequirePackage{locpream}| minimizes the compilation time.
When there are a large number of standalone files, this difference can
amount to a significant amount of time.

If you want to reuse compiled results between compilations of the
master \LaTeX\ file, you will want to manually run the following
command.

\begin{dispListing}
pdflatex -shell-escape locpream-standalone-simple.tex
\end{dispListing}

Then you would omit the call to \com{LocalPreambleCompile} and just
call \com{LocalPreambleRead} as in the following.

\begin{dispExample}
<\LocalPreambleRead[file=locpream-standalone-simple]>
\end{dispExample}
\end{docCommand}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Options}%
\label{sec:Options}

Options that are passed to commands are parsed using the \pkg{keyval}
package.
Their syntax is
$|[|  \meta{key$_1$}|=|\meta{value$_1$}
 |,|\ \meta{key$_2$}|=|\meta{value$_2$}|,|\ \cdots
 |,|\ \meta{key$_n$}|=|\meta{value$_n$}|]|$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{docCommand}{locpreamkeys}{\marg{options}}

You can set the default values for options with the \Com{locpreamkeys}
command.
For example, if want to default to use |mypdflatex| instead of
|pdflatex| to compile \LaTeX\ code, you could use the following
command.

\begin{dispListing}
\locpreamkeys{latex=mylatex}
\end{dispListing}
\marginpar{TEST}

You can also specify this by passing the option when the \Pkg{locpream}
package is loaded as seen in the following example.

\begin{dispListing}
\usepackage[latex=mylatex]{locpream}
\end{dispListing}
\marginpar{TEST}
\end{docCommand}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Commonly Used Options}%
\label{subsec:Commonly Used Options}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{documentclass}{=\meta{class}}{initially |article|}

This option specifies the document class used (by way of
\Com{documentclass}) by the intermediate \LaTeX\ file that is generated
for each piece of code with a local preamble.
For example, the following uses the \pkg{proc} class, which (unlike
\pkg{article}) contains the \Com{pagename} macro.

\begin{dispExample}
<\localpreamble[documentclass=proc]{\pagename}>
\end{dispExample}

If the value of this key is blank, a \Com{documentclass} declaration is
not added to the intermediate file.
In this case, you will likely want to put a \Com{documentclass}
declaration in the \key{preamble} option as in the following example.
(This could also be achieved with |documentclass=prog|, so doing it
this way is gratuitous and solely for the sake of example.)

\begin{dispExample}
<\localpreamble[documentclass={}, preamble={\documentclass{proc}}]
   {\pagename}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%
\begin{docKey}{documentclass/options}{=\meta{options}}{initially empty}

This option specifies options to pass to the document class.
For example, the following specifies passing the |12pt| option to
\pkg{article}, which changes the default font to be 12 points tall.

\begin{dispExample}
<\localpreamble[documentclass/options={12pt}]{M}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{preamble}{=\meta{code}}{initially empty}

This options specifies \LaTeX\ code to be put in the preamble of the
intermediate \LaTeX\ file.
For example, you might want to load packages as in the following.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{amsmath}}]{$\iint xy\,dx\,dy$}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{math}{=\docValue{false}, \docValue{inline}, or
  \docValue{display}}{initially \docValue{false}}

This option controls whether the code in the body of
\com{localpreamble} or \env{localpreambleenv} is treated as math, and
if so, whether it is inline math or display math.
The following examples demonstrate the possible values for this option.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{amsmath}}, math=false]
   {$\iint xy\,dx\,dy$}>
\end{dispExample}

\begin{dispExample}
<\localpreamble[preamble={\usepackage{amsmath}}, math=inline]
   {\iint xy\,dx\,dy}>
\end{dispExample}

\begin{dispExample}
<\localpreamble[preamble={\usepackage{amsmath}}, math=display]
   {\iint xy\,dx\,dy}>
\end{dispExample}

Note that, as seen in the following example, |math=display| is
equivalent to the incantation
|\[\localpreamble{$\displaystyle|\meta{code}|$}\]|.

\begin{dispExample}
<\[\localpreamble[preamble={\usepackage{amsmath}}]
     {$\displaystyle\iint xy\,dx\,dy$}\]>
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{margin/top}{=\meta{length}}{initially |1in|}\end{docKey}
\begin{docKey}{margin/bottom}{=\meta{length}}{initially |1in|}\end{docKey}
\begin{docKey}{margin/left}{=\meta{length}}{initially |1in|}\end{docKey}
\begin{docKey}{margin/right}{=\meta{length}}{initially |1in|}

These options specify the margin to place around the \LaTeX\ code being
separately compiled.
This is useful if the \LaTeX\ code draws outside its bounding box.
If there is not enough margin to contain the drawn portions, the result
may be clipped.
For example, compare the two following examples.
The 2-inch rules are clipped when the default 1-inch margins are used
but are not clipped when 3-inch margins are used.

\begin{dispExample}
\vspace{2in}
\hspace{2in}
<\begin{localpreambleenv}
   \rlap{\rule[3pt]{2in}{1pt}}%
   \llap{\rule[3pt]{2in}{1pt}}%
   \smash{\rule[-2in]{1pt}{4in}}%
 \end{localpreambleenv}>
\vspace{2.2in}
\end{dispExample}

\begin{dispExample}
\vspace{2in}
\hspace{2in}
<\begin{localpreambleenv}[
   margin/top=3in, margin/bottom=3in,
   margin/left=3in, margin/right=3in]
   \rlap{\rule[3pt]{2in}{1pt}}%
   \llap{\rule[3pt]{2in}{1pt}}%
   \smash{\rule[-2in]{1pt}{4in}}%
 \end{localpreambleenv}>
\vspace{2.2in}
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{debug}{=\docValue{true} or \docValue{false}}{initially \docValue{false}}

Whether to print tracing information to standard out.
This is helpful in determining exactly what part of a command failed.

For example, consider the following call to \com{localpreamble}.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{amsmath}}]{$\iint xy\,dx\,dy$}>
\end{dispExample}

When the \Key{debug} option is |true|, lines like the following will be
printed to the standard output.

\begin{dispListing}
**** Begin \LocalPreambleWrite on {locpream-locpream-21}
       with {$\iint xy\,dx\,dy$}
**** End \LocalPreambleWrite on {locpream-locpream-21}
**** Begin \LocalPreambleCompile on {locpream-locpream-21}
**** End \LocalPreambleCompile on {locpream-locpream-21}
**** Begin \LocalPreambleRead on {locpream-locpream-21}
**** End \LocalPreambleRead on {locpream-locpream-21}
\end{dispListing}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Uncommonly Used Options}%
\label{subsec:Uncommonly Used Options}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{before}{=\meta{code}}{%
  initially |\textbackslash{}stepcounter\{locpream@number\}|}\end{docKey}
\begin{docKey}{after}{=\meta{code}}{initially empty}

These options specify \LaTeX\ code to run before or after the rest of
the code in a \com{localpreamble} command or a \env{localpreambleenv}
environment.
This is particularly useful for incrementing any counters used in the
\key{file} option.
The following is an example of these in action.

\begin{dispExample}
\newcounter{foo}%
\thefoo
<\localpreamble[file=locpream-locpream-before,
                before={\stepcounter{foo}}]{}>%
\thefoo
<\localpreamble[file=locpream-locpream-after,
                after={\stepcounter{foo}}]{}>%
\thefoo
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{before write}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{after write}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{before compile}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{after compile}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{before read}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{after read}{=\meta{code}}{initially empty}

These options specify code to run before or after
\com{LocalPreambleWrite}, \com{LocalPreambleCompile}, or
\com{LocalPreambleRead}.
The following is an example of these in action.

\begin{dispExample}
\newcounter{baz}%
\thebaz
<\localpreamble[file=locpream-locpream-before-read,
                before read={\stepcounter{baz}}]{}>%
\thebaz
<\localpreamble[file=locpream-locpream-after-read,
                after read={\stepcounter{baz}}]{}>%
\thebaz
<\localpreamble[file=locpream-locpream-before-compile,
                before compile={\stepcounter{baz}}]{}>%
\thebaz
<\localpreamble[file=locpream-locpream-after-compile,
                after compile={\stepcounter{baz}}]{}>%
\thebaz
<\localpreamble[file=locpream-locpream-before-write,
                before write={\stepcounter{baz}}]{}>%
\thebaz
<\localpreamble[file=locpream-locpream-after-write,
                after write={\stepcounter{baz}}]{}>%
\thebaz
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{before savebox}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{after savebox}{=\meta{code}}{initially empty}

These options specify code to be put before or after the \Com{savebox}
that is used in the intermediate \LaTeX\ file.
These options correspond to the \meta{before savebox} and \meta{after
  savebox} arguments of \com{LocalPreambleCode}.

These options are rarely needed.

The following example demonstrates the use of these options, though
since there are other ways to accomplish this effect, doing it in this
way is gratuitous and solely for the sake of example.
Note that we have to set the margins to small or zero lengths to
prevent the gray area from overlapping the rest of the page.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{xcolor}},
                before savebox={\newcommand{\p}[1]{(##1)}},
                after savebox={\pagecolor{gray!50}},
                margin/top=1pt, margin/bottom=1pt,
                margin/left=0pt, margin/right=0pt]
  {\p{x}}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{before usebox}{=\meta{code}}{initially empty}\end{docKey}
\begin{docKey}{after usebox}{=\meta{code}}{initially empty}

These options specify code to be put before or after the \Com{usebox}
that is used in the intermediate \LaTeX\ file.
These options correspond to the \meta{before usebox} and \meta{after
  usebox} arguments of \com{LocalPreambleCode}.

These options are rarely needed.

The following example demonstrates the use of these options, though
since there are other ways to accomplish this effect, doing it this
way is gratuitous and solely for the sake of example.
Note that we have to set the margins to small or zero lengths to
prevent the gray area from overlapping the rest of the page.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{xcolor}},
                before usebox={\pagecolor{gray!50}},
                margin/top=1pt, margin/bottom=1pt,
                margin/left=0pt, margin/right=0pt]
   {ABC}>
<\localpreamble[preamble={\usepackage{xcolor}},
                after usebox={\pagecolor{gray!50}},
                margin/top=1pt, margin/bottom=1pt,
                margin/left=0pt, margin/right=0pt]
   {DEF}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{latex}{=\meta{program name}}{initially empty}

This option specifies the program used to compile the intermediate
\LaTeX\ file.
Blank means to autodetect between |pdflatex|, |xelatex|, or |lualatex|
to match whatever the master document is being compiled with.
For example, if you want to force certain code to run under |pdflatex|
or |lualatex|, you can do the following.

\begin{dispExample}
<\localpreamble[latex=pdflatex]{\pdfescapehex{ABC}}>
<\localpreamble[latex=lualatex]{\directlua{tex.print("ABC")}}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%
\begin{docKey}{latex/options}{=\meta{code}}{%
  initially |-halt-on-error -interaction=batchmode|}

This option specifies what command-line options to pass to \LaTeX\ when
compiling the intermediate \LaTeX\ file.

Note that if you change this, you will almost certainly want to include
the |-halt-on-error| and |-interaction=batchmode| options in whatever
you change it to.

For example, the \pkg{ifplatform} package needs the |-shell-escape|
option in order to give precise platform information as seen in the
following.

\begin{dispExample}
<\localpreamble[preamble={\usepackage{ifplatform}}]
   {\platformname}>
<\localpreamble[preamble={\usepackage{ifplatform}},
                latex/options={-shell-escape -halt-on-error
                               -interaction=batchmode}]
   {\platformname}>
\end{dispExample}

Note that if the documentation (i.e., the document you are reading) is
compiled on Windows, then the two calls to \com{localpreamble} in this
example produce the same results as each other, but on any other
platform they are different.
\marginpar{TEST}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{file}{=\meta{basename}}{%
  initially |\textbackslash{}jobname-locpream-%
             \textbackslash{}arabic\{locpream@number\}|}

This option specifies the basename of the intermediate files that are
generated.
For example, the following uses |locpream-locpream-file| as the
basename.

\begin{dispExample}
<\localpreamble[file=locpream-locpream-file,
                preamble={\usepackage{amsmath}}]
   {$\iint xy\,dx\,dy$}>
\end{dispExample}

Be careful not to use the same filename for two different pieces of
code as this can lead to unexpected results.
\end{docKey}

%%%%%%%%%%
\begin{docKey}{file/tex}{=\meta{extension}}{initially |.tex|}\end{docKey}
\begin{docKey}{file/dim}{=\meta{extension}}{initially |.dim|}\end{docKey}
\begin{docKey}{file/out}{=\meta{extension}}{initially |.pdf|}

These options specify the extensions to use for the intermediate
\LaTeX, dimension, and compiled files, respectively.

These options are rarely needed.

An example of using them is the following.

\begin{dispExample}
\DeclareGraphicsRule{.mypdf}{pdf}{.mypdf}{}%
<\localpreamble[
   file/tex=.mytex, file/dim=.mydim, file/out=.mypdf,
   file=locpream-locpream-extension,
   before read={\ShellEscape{mv locpream-locpream-extension.pdf
                                locpream-locpream-extension.mypdf}}]
   {ABC}>
\end{dispExample}
\end{docKey}

\begin{docKey}{file/tex file}{=\meta{TODO}}{TODO}
TODO
\marginpar{TODO}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%
\begin{docKey}{includegraphics/options}{=\meta{key-value sequence}}{initially empty}

This option specifies options to be passed to the \Com{includegraphics}
command that is used to read into the master document the result of
compiling the \LaTeX\ code.
For example, the following uses \Key{angle} to rotate the image read by
\Com{includegraphics}.

\begin{dispExample}
<\localpreamble[includegraphics/options={angle=45}]{M}>
\end{dispExample}
\end{docKey}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Issues and Workarounds}%
\label{sec:Issues and Workarounds}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Document Not Updating}%
\label{subsec:Document Not Updating}

A common issue is changing the \LaTeX\ code in a \com{localpreamble} or
\env{localpreambleenv} but those changes not being reflected in the
master document after re-compiling the master document.
The cause of this is that \Pkg{locpream} has no way to detect whether
compiling the intermediate \LaTeX\ file succeeded or failed.
If compilation of the intermediate \LaTeX\ file fails, the dimension
file and the resulting PDF file from a previous compilation will not be
overwritten.

To fix this, delete the PDF and dimension files.
Then failure of the compilation of the intermediate \LaTeX\ file will
cause a file-not-found error when the PDF and dimension file are read.
You can then use this file-not-found error to let you know when you
have fixed that \LaTeX\ code.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Hash Symbols and Command Arguments}%
\label{subsec:Hash Symbols and Command Arguments}

Using hash symbols, such as when referencing a command
argument~(e.g.,~|#1|), can lead to problems.
For example, the following would lead to an error.

\begin{dispListing}
<\localpreamble[preamble={\newcommand{\p}[1]{(#1)}}]{\p{x}}>
\end{dispListing}

The solution to this is to use double hashes~(e.g,~|##1| instead of
|#1|) as demonstrated in the following.

\begin{dispExample}
<\localpreamble[preamble={\newcommand{\p}[1]{(##1)}}]{\p{x}}>
\end{dispExample}

\begin{dispExample}
<\begin{localpreambleenv}[preamble={\newcommand{\p}[1]{(##1)}}]
   \p{x}
 \end{localpreambleenv}>
\end{dispExample}

This even applies in the body of the command \com{localpreamble} and
the environment \env{localpreambleenv} as seen in the following.

\begin{dispExample}
<\localpreamble{\newcommand{\p}[1]{(##1)}\p{x}}>
\end{dispExample}

\begin{dispExample}
<\begin{localpreambleenv}
   \newcommand{\p}[1]{(##1)}%
   \p{x}
 \end{localpreambleenv}>
\end{dispExample}

This also applies to standalone files as seen in the following.

\showfile{locpream-standalone-hash.tex}

\begin{dispExample}
<\LocalPreambleCompile[file=locpream-standalone-hash]>
<\LocalPreambleRead[file=locpream-standalone-hash]>
\end{dispExample}

Finally, \com{newlocalpreamble} and \com{newlocalpreambleenv} require
\textit{four} hashes due to an extra level of indirection occurring in
them as demonstrated in the following examples.

\begin{dispExample}
<\newlocalpreamble[preamble={\newcommand{\p}[1]{(####1)}}]{\paren}>
<\paren{\p{x}}>
\end{dispExample}

\begin{dispExample}
<\newlocalpreambleenv[preamble={\newcommand{\p}[1]{(####1)}}]{paren}>
<\begin{paren}\p{x}\end{paren}>
\end{dispExample}

However, in their bodies this does not apply, and only two hashes should
be used as demonstrated in the following.

\begin{dispExample}
<\newlocalpreamble{\paren}>
<\paren{\newcommand{\parens}[1]{(##1)}\parens{x}}>
\end{dispExample}

\begin{dispExample}
<\newlocalpreambleenv{paren}>
<\begin{paren}
   \newcommand{\parens}[1]{(##1)}%
   \parens{x}
 \end{paren}>
\end{dispExample}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Category Codes}%
\label{subsec:Category Codes}

Some commands change the category codes of characters.
These pose a problem for use with commands from the \Pkg{locpream}
package as the arguments to commands are parsed before those category
codes have changed.
The way to work around this is to use the \Com{scantokens} macro to
cause parts of those arguments to be re-parsed.

For example, the \Com{DeclareFontShape} macro redefines category codes
for characters used in its argument.
Thus, to use it one must insert a call to \Com{scantokens} as in the
following.

\begin{dispExample}
<\localpreamble[preamble={
                  \usepackage{pifont}
                  \DeclareFontFamily{U}{msa}{}
                  \scantokens{
                    \DeclareFontShape
                      {U}{msa}{m}{n}
                      {<-6>msam5<6-8>msam7<8->msam10}{}\relax}}]
   {\Pisymbol{msa}{15}}>
\end{dispExample}

Note that the \Com{relax} before the end of the argument to
\Com{scantokens} ensures that \Com{scantokens} does not insert an extra
space at the end.
See
\url{https://tex.stackexchange.com/questions/117906/use-of-everyeof-and-endlinechar-with-scantokens}
for details.

This trick also works when using a standalone file as in the following.

\showfile{locpream-standalone-catcode.tex}

\begin{dispExample}
<\LocalPreambleCompile[file=locpream-standalone-catcode]>
<\LocalPreambleRead[file=locpream-standalone-catcode]>
\end{dispExample}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Changelog}
All notable changes to this project will be documented here.

The format is based on \href{https://keepachangelog.com/en/1.0.0/}{Keep a Changelog}
and this project adheres to \href{https://semver.org/spec/v2.0.0.html}{Semantic Versioning}.

% Commands:
%  \added      added features
%  \changed    changed features
%  \deprecated deprecated features
%  \removed    features which have been removed
%  \fixed      bug fixes
%  \security   security-fixes and closed security holes
%
% Options:
%  yanked:
%    Indicates that the release was revoked due to a "serious bug or
%    security issue"; prints a visible notice next to the version
%    number
%  simple:
%     Indicates this version isn't split up into \added, \changed, etc.
%     categories; if this option is given, a version environment acts
%     like a plain itemize

% TODO: add links to github, ctan and personal homepage
% TODO: error tests.  Maybe in directory and can use relative directory to use package?
% TODO: fix: Package hyperref Warning: Token not allowed in a PDF string (PDFDocEncoding): removing `\char' on input line 442.

\begin{changelog}
%\begin{version} % Unreleased
%  \added
%    \item TODO
%\end{version}
\begin{version}[version=0.1.0, date=2019-01-05, author=Michael D. Adams, simple]
  \item Initial version
\end{version}
\end{changelog}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\printindex

\end{document}
