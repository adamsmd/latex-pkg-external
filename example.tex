\documentclass[10pt]{ltxdoc}

\usepackage{external}
\externalkeys{debug=true}

\usepackage{tcolorbox}
\tcbuselibrary{listings}
% TODO: center listings?

\usepackage{cleveref}

\newcommand{\env}[1]{\texttt{#1}}
\newcommand{\pkg}[1]{\texttt{#1}}
\newcommand{\opt}[1]{\texttt{#1}}

\newcommand{\showfile}[1]{
  \begin{tcolorbox}[title=\texttt{#1}]
  \verbatiminput{#1}
  \end{tcolorbox}
}

\def\sz{%
  \rule{0.2em}{7pt}%
  \llap{\rule[8pt]{0.2em}{2pt}}%
}

\def\sx{%
  \rule{1.5pt}{4.5pt}%
  \llap{\rule[5.5pt]{1.5pt}{1.5pt}}%
  \llap{\rule[8pt]{1.5pt}{2pt}}%
}

\def\gl{%
%  \rule[3.5pt]{3.5pt}{1pt}%
  \rule[5.5pt]{3.5pt}{1.5pt}%
  \llap{\sx}}
\def\gr{%
  \rlap{\sx}%
%  \rule[3.5pt]{3.5pt}{1pt}%
  \rule[5.5pt]{3.5pt}{1.5pt}%
  }
%\rule[3pt]{0.4em}{2pt}\llap{\sz}}

% TODO: error tests.  Maybe in directory and can use relative directory to use package?

\begin{document}

\title{The \pkg{external} package}
\author{Michael D. Adams\\\url{https://michaeldadams.org}}
\date{2019/01/15 v0.1}
\maketitle

\begin{abstract}
This package allows you to include the result of rendering \LaTeX\ code
in a separate document.
This is useful when you want to use symbols from a package that you do
not want to load into your main document.
For example your main document may use symbols from multiple packages
that conflict or otherwise cannot be loaded together.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introduction}
\label{sec:Introduction}

This package allows you to include the result of rendering \LaTeX\ code
in a separate document.
For example, you may want to use symbols from multiple packages that
cannot be loaded at the same time.
By rendering them in separate documents and then including their
rendered results in a master document, this allows you to render the
symbols from each part in their own package.

TODO: this document also serves as test cases

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Quick Start}
\label{subsec:Quick Start}

Suppose you want to use the \cs{textbeta} symbol from the
\pkg{textgreek} package, but you do do not want to load the
\pkg{textgreek} package into your master document.
(Maybe it is incompatible with some other package that you use or maybe
\LaTeX\ has run out of space for declaring new fonts.)
You can simply render \cs{textbeta} using the \cs{external} command as
in the following.

\begin{tcblisting}{}
An atom undergoing
\external[preamble={\usepackage{textgreek}}]{\textbeta-decay}
can emit an electron.
\end{tcblisting}

If you prefer, you can also use the environment \env{externalenv} as in the
following.
(The only difference between the \cs{external} command and the
\env{externalenv} environment is that one is a command and the other in
an environment.)

\begin{tcblisting}{}
An atom undergoing
\begin{externalenv}[preamble={\usepackage{textgreek}}]
\textbeta-decay
\end{externalenv}
~can emit an electron.
\end{tcblisting}

If you want to format the \LaTeX\ code as ``display'' math, use the
|math=display| option as in the following example.

\begin{tcblisting}{}
\external[preamble={\usepackage{amsmath}},math=display]
  {\iint xy\,dx\,dy}
\end{tcblisting}

Note that in all these examples even though they rendered as separate
documents, they are automatically properly spaced relative to the
surrounding text.
In the resulting PDF, they even behave properly with regard to
copy-and-paste.

See \Cref{sec:Options} more details about options and \Cref{sec:Issues
  and Workarounds} for common issues and their workarounds.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Notation}
\label{subsec:Notation}

For debugging purposes, this documentation surrounds most examples with
a \cs{sz} macro that we use as a sort of registration mark.
This makes it easy to see whether there is extra space to the left or
right of a symbol and whether parts of the symbol extend below the
baseline.
The bottom bar starts at the baseline and goes up 7 points.
The top bar starts at 8 points above the baseline and extends up to 10
points.
For example we might see something like the following.
Note that the top of the ``M'' is at 7 points above the baseline
even though the font size is 10 points.

\begin{tcblisting}{}
\sz M\sz
~\gl x\gr
~\gl M\gr
~\gl\gr
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Related Packages}
\label{subsec:Relatec Packages}

TODO: standalone, tikz, pgfplots

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{High-level Commands}
\label{sec:High-level Commands}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\cs{external} and \env{externalenv}}
\label{subsec:external and externalenv}

\cs{external}\oarg{options}\marg{body}

TODO: \cs{begin}\texttt{\{externalenv\}}\oarg{options}

The commands \cs{external} and \env{externalenv} are the main commands
of this package.
The \meta{body} is the \LaTeX\ code to be externally rendered.
An examples of their usage is the following.

\begin{tcblisting}{}
\sz
\external[preamble={\usepackage{amsmath}},math=inline]
  {\iint xy\,dx\,dy}%
\sz~\sz
\begin{externalenv}[preamble={\usepackage{amsmath}},math=inline]
  \iint xy\,dx\,dy
\end{externalenv}
\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\cs{newexternal} and \env{newexternalenv}}
\label{subsec:newexternal and newexternalenv}

\cs{newexternal}\oarg{options}\marg{command name}

\cs{newexternalenv}\oarg{options}\marg{command name}

It is sometimes useful to define versions of \cs{newexternal} and
\env{externalenv} that have their own custom default values for their
options.
These can be created with \cs{newexternal} and \env{newexternalenv}.

For example, you might want to define versions that load the
\pkg{amsmath} package by default.
With \cs{newexternal}, this can be done as follows.

\begin{tcblisting}{}
\sz\newexternal[preamble={\usepackage{amsmath}},math=inline]{\ams}\sz~%
\sz\ams{\iint xy\,dx\,dy}\sz~%
\sz\ams[math=false]{$\iint xyzw\,dx\,dy$}\sz
\end{tcblisting}

With \cs{newexternalenv}, this can be done as follows.

\begin{tcblisting}{}
\sz
\newexternalenv[preamble={\usepackage{amsmath}},math=inline]{amsenv}%
\sz~%
\sz\begin{amsenv}\iint xy\,dx\,dy\end{amsenv}\sz~%
\sz\begin{amsenv}[math=false]$\iint xyzw\,dx\,dy$\end{amsenv}\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Options}
\label{sec:Options}

Commands that take an optional argument take a list of options that are
parsed using the \pkg{keyval} package.
Their syntax is of the form:
$$
|[|\meta{key$_1$}|=|\meta{value$_1$}|, |\meta{key$_2$}|=|\meta{value$_2$}|, |\cdots|, |\meta{key$_n$}|=|\meta{value$_n$}|]|
$$

\subsection{\cs{externalkeys}}
\label{subsec:externalkeys}

\cs{externalkeys}\marg{options}

You can set the default value for any options with the
\cs{externalkeys} command.
For example, if want to default to use |mypdflatex| instead of
|pdflatex| to compile \LaTeX\ code, you could add the following
command.

\begin{tcolorbox}
\begin{verbatim}
\externalkeys{latex=mylatex}
\end{verbatim}
\end{tcolorbox}

You can also specify this by passing the option when the \pkg{external}
package is loaded.

\begin{tcolorbox}
\begin{verbatim}
\usepackage[latex=mylatex]{external}
\end{verbatim}
\end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{action}}
\label{subsec:action}

Type: String

Default: |\stepcounter{external@number}|

This option specifies a bit of code to run before the rest of the code
in each \cs{external} command or \env{externalenv} environment.
This is particularly is useful for incrementing any counters used in
the \opt{file} option.

\begin{tcblisting}{}
\newcounter{foo}%
\thefoo
\sz
\external[file=example-inline-action,action={\setcounter{foo}{100}}]{}%
\sz
\thefoo
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{documentclass}}
\label{subsec:documentclass}

Type: String

Default: |article|

This option specifies (by way of \cs{documentclass}) the document class
to be used by the intermediate \LaTeX\ file that is generated for each
bit of externally rendered code.
For example, the following uses the \pkg{proc} class, which (unlike
\pkg{article}) contains the \cs{pagename} macro.

\begin{tcblisting}{}
\sz\external[documentclass=proc]{\pagename}\sz
\end{tcblisting}

If the value of this macro is blank, a \cs{documentclass} declaration
it not added to the intermediate file.
In this case, you will likely want to put a \cs{documentclass}
declaration in the \opt{preamble} option as in the following example,
though since this could be achieved with |documentclass=prog|, doing it
this way is gratuitous and solely for the sake of an example.

\begin{tcblisting}{}
\sz
\external[documentclass={},preamble={\documentclass{proc}}]{\pagename}%
\sz
\end{tcblisting}

This example demonstrates the use of this option, though since
the \cs{newcommand} could be put in the preamble, putting it in
\opt{pre-savebox} is gratuitous and solely for the sake of an example.

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Option: \opt{documentclass/options}}
\label{subsec:documentclass/options}

Type: String

Default: (blank)

This options specifies any options to pass to the document class to be
used by the \LaTeX\ file that is generated for each bit of externally
rendered code.
For example, the following specifies the |12pt| option to
\pkg{article}, which changes the default font to be 12 points tall.

\begin{tcblisting}{}
\sz\external[documentclass/options={12pt}]{M}\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{preamble}}
\label{subsec:preamble}

Type: String

Default: (blank)

This options specifies code to be put in the preamble of the
intermediate \LaTeX\ file that is generated for each bit of externally
rendered code.

For example, you might want to load needed packages as in the following
example.

\begin{tcblisting}{}
\sz\external[preamble={\usepackage{amsmath}}]{$\iint xy\,dx\,dy$}\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{pre-savebox}}
\label{subsec:pre-savebox}

Type: String

Default: (blank)

This option specifies code to be put before the \cs{savebox} that is
used in the intermediate \LaTeX\ file that is generated for the
externally rendered code.
This option corresponds to the pre-savebox argument of
\cs{ExternalCode}.
This option is rarely needed.

The following example demonstrates the use of this option, though since
the \cs{newcommand} could be put in the preamble, putting it in
\opt{pre-savebox} is gratuitous and solely for the sake of an example.

\begin{tcblisting}{}
\sz\external[pre-savebox={\newcommand{\p}[1]{(##1)}}]{\p{x}}\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{pre-usebox}}
\label{subsec:pre-usebox}

Type: String

Default: (blank)

This option specifies code to be put before the \cs{usebox} that is
used in the intermediate \LaTeX\ file that is generated for the
externally rendered code.
This option corresponds to the pre-usebox argument of
\cs{ExternalCode}.
This option is rarely needed.

The following example demonstrates the use of this option, though since
there are other ways to accomplish this effect, using \opt{pre-usebox}
is gratuitous and solely for the sake of an example.
Note that we have to set the margins to small or zero lengths to
prevent them from overlapping the rest of the page.

\begin{tcblisting}{}
\sz
\external[preamble={\usepackage{xcolor}},
          pre-usebox={\pagecolor{yellow!30}},
          margin/top=1pt,margin/bottom=1pt,
          margin/left=0pt,margin/right=0pt]
  {ABC}%
\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{math}}
\label{subsec:math}

Type: |false|, |inline|, or |display|

Default: |false|

This option determines whether the body of \cs{external} or
\env{externalenv} is treated as math, and if so, whether it is inline
math or display math.
The following demonstrate each value possible for this option.

\begin{tcblisting}{}
\sz
\external[preamble={\usepackage{amsmath}},math=false]
  {$\iint xy\,dx\,dy$}%
\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz
\external[preamble={\usepackage{amsmath}},math=inline]
  {\iint xy\,dx\,dy}%
\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz
\external[preamble={\usepackage{amsmath}},math=display]
  {\iint xy\,dx\,dy}%
\sz
\end{tcblisting}

Note that |math=display|, as seen in the following example, is
equivalent to the incantation |\[\external{$\displaystyle...$}\]|.

\begin{tcblisting}{}
\sz
\[\external[preamble={\usepackage{amsmath}}]
    {$\displaystyle\iint xy\,dx\,dy$}\]%
\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{latex}}
\label{subsec:latex}

Type: String

Default: (blank)

This option specifies the program to use to compile the intermediate
\LaTeX\ file that is generated for each bit of externally rendered
code.

Blank means to autodetect between |pdflatex|, |xelatex|, or |lualatex|
to match whatever the master document is being compiled with.

TODO: example

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Option: \opt{latex/options}}
\label{subsubsec:latex/options}

Type: String

Default: |-halt-on-error -interaction=batchmode|

This option specifies what command line options to pass to \LaTeX\ when
compiling the intermediate \LaTeX\ file that is generated for each bit
of externally rendered code.

Note that if you change this, you will almost certainly want to include
the |-halt-on-error| and |-interaction=batchmode| options in whatever
you change it to.

For example, the \pkg{ifplatform} package needs the |-shell-escape|
option in order to give precise platform information.
This can be specified as in the following.

\begin{tcblisting}{}
\sz
\external[preamble={\usepackage{ifplatform}}]
  {\platformname}%
\sz~\sz
\external[preamble={\usepackage{ifplatform}},
          latex/options={-shell-escape -halt-on-error
                         -interaction=batchmode}]
  {\platformname}%
\sz
\end{tcblisting}

Note that if this document was compiled on Windows, then the two calls
to \cs{external} in this example will produce the same results as each
other, but on any other platform they will be different.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{file}}
\label{subsec:file}

Type: String

Default: |\jobname-external-\arabic{external@number}|

This option specifies the basename of the intermediate files that are
generated for each bit of externally rendered code.

For example, the following uses |example-external-file| as the
basename.

\begin{tcblisting}{}
An atom undergoing
\external[file=example-external-file,preamble={\usepackage{textgreek}}]
  {\textbeta-decay}
can emit an electron.
\end{tcblisting}

Be careful not to use the same filename for two different bits of
externally rendered code as that can lead to unexpected results.

\subsubsection{Option: \opt{file/tex}, \opt{file/dim}, and \opt{file/pdf}}

Type: String

Defaults: Respectively |.tex|, |.dim|, and |.pdf|

These options specify the extensions to use for the intermediate
\LaTeX, dimension, and PDF files, respectively.
This option is rarely needed.

TODO: example

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{margin}}
\label{subsec:margin}

%%%%%%%%%%%%%%%%%%%%
\subsubsection{Option: \opt{margin/top}, \opt{margin/bottom}, \opt{margin/left}, and \opt{margin/right}}
\label{subsubsec:margin/top, margin/bottom, margin/left, and margin/right}

Type: Length

Default: |1in|

These options specify the margin to around the \LaTeX\ code being
rendered externally.
This is useful if the \LaTeX\ code being rendered externally draws
outside its bounding box.
If there is not enough margin to contain the drawn portions, the result
may be clipped.
For example, in each of the following a 2 inch rule is clipped when the
default margins are used but is not clipped when a 3 inch rule is used.

TODO: combine into one big example

\begin{tcblisting}{}
\sz\external{M\rlap{\rule[3pt]{2in}{1pt}}M}\sz

\sz\external[margin/right=3in]{M\rlap{\rule[3pt]{2in}{1pt}}M}\sz
\end{tcblisting}

\begin{tcblisting}{}
\begin{flushright}
\sz\external{M\llap{\rule[3pt]{2in}{1pt}}M}\sz

\sz\external[margin/left=3in]{M\llap{\rule[3pt]{2in}{1pt}}M}\sz
\end{flushright}
\end{tcblisting}

\begin{tcblisting}{}
\vspace{2in}
\sz\external{M\smash{\rule{1pt}{2in}}M}\sz~
\sz\external[margin/top=3in]{M\smash{\rule{1pt}{2in}}M}\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz\external{M\smash{\rule[-2in]{1pt}{2in}}M}\sz~
\sz\external[margin/bottom=3in]{M\smash{\rule[-2in]{1pt}{2in}}M}\sz
\vspace{2in}
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{includegraphics}}
\label{subsec:includegraphics}

\subsubsection{Option: \opt{includegraphics/options}}
\label{subsubsec:includegraphics/options}

Type: String

Default: (blank)

This option specifies options to be passed to the \cs{includegraphics}
command that is used to read into the master document the result of
rendering the \LaTeX\ code to be rendered separately.
For example, the following uses \opt{angle} to rotate the image read in
by \cs{includegraphics}.

\begin{tcblisting}{}
\sz\external[includegraphics/options={angle=45}]{M}\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Option: \opt{debug}}
\label{subsec:debug}

Type: |false| or |true|

Default: |false|

Whether to print tracing into to standard out.
This is helpful in determining exactly what part of a command failed.

For example, consider the following call to \cs{external}.

\typeout{+++++++++++++++++}
\begin{tcblisting}{}
\sz\external[preamble={\usepackage{amsmath}}]{$\iint xy\,dx\,dy$}\sz
\end{tcblisting}
\typeout{+++++++++++++++++}

When the \opt{debug} option is |true|, lines like the following will be
printed to the standard output.

\begin{tcolorbox}
\begin{verbatim}
**** Begin \ExternalWrite on {example-external-21}
       with {$\iint xy\,dx\,dy$}
**** End \ExternalWrite on {example-external-21}
**** Begin \ExternalCompile on {example-external-21}
**** End \ExternalCompile on {example-external-21}
**** Begin \ExternalRead on {example-external-21}
**** End \ExternalRead on {example-external-21}
\end{verbatim}
\end{tcolorbox}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Low-level Commands}
\label{sec:Low-level Commands}

\subsection{\cs{ExternalWrite}, \cs{ExternalCompile}, and \cs{ExternalRead}}
\label{subsec:ExternalWrite, ExternalCompile, and ExternalRead}

\cs{ExternalWrite}\oarg{options}\marg{body}

\cs{ExternalCompile}\oarg{options}

\cs{ExternalRead}\oarg{options}

Both the \cs{external} command and the \env{externalenv} environment
are broken up into three phases:
\begin{enumerate}
\item writing the intermediate \LaTeX\ file,
\item compiling the intermediate \LaTeX\ file into a PDF file, and
\item reading the resulting intermediate PDF file.
\end{enumerate}

These are handled with \cs{ExternalWrite}, \cs{ExternalCompile}, and
\cs{ExternalRead}, respectively.
For example, instead of using \cs{external}, you could explicitly call
each of these as in the following.

\begin{tcblisting}{}
\sz
\ExternalWrite[file=example-external-separate,
               preamble={\usepackage{amsmath}}]
  {$\iint xy\,dx\,dy$}%
\sz~%
\sz\ExternalCompile[file=example-external-separate]\sz~%
\sz\ExternalRead[file=example-external-separate]\sz
\end{tcblisting}

Taking explicit control of these is particularly useful if you want to
cache compilation results.
See \Cref{subsec:ExternalCode} for an example of this.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\cs{ExternalCode}}
\label{subsec:ExternalCode}

\cs{ExternalCode}\marg{dimension file}\marg{preamble}\marg{pre-savebox}\marg{body}\marg{pre-usebox}

TODO: weave ``Standalone Source File'' to test earlier?

This command expands to the code used in the intermediate \LaTeX\ file.
It is useful if you want to store the \LaTeX\ code to be rendered in a
separate file and reuse the compiled results between compilations
of the master \LaTeX\ file.

The \meta{dimension file} is the full filename of the dimension file to
be generated.
The \meta{preamble}, \meta{pre-savebox}, and \meta{pre-usebox} are the
same as the corresponding options in \Cref{sec:Options}.
The \meta{body} is the \LaTeX\ code to be rendered.

For example, you might write the following standalone file.

\showfile{example-standalone-simple.tex}

Then in your master file you can compile and read that standalone file
with the following commands.

\begin{tcblisting}{}
\sz\ExternalCompile[file=example-standalone-simple]\sz~%
\sz\ExternalRead[file=example-standalone-simple]\sz
\end{tcblisting}

TODO: GL vs GR

Be careful if you rename a standalone file, as you will need to change
the \meta{dimension file} argument to match.
Otherwise, you will get an error along the lines of
|In \ExternalRead, input dimension file does not exist|.

Also note that \cs{ExternalCode} is defined in the \pkg{external.code}
package.
This package is imported by the main \pkg{external} package, so you do
not necessarily need to import it separately.
However, \pkg{external.code} is designed be minimal and has
dependencies.
Thus in the previous example, by doing |\RequirePackage{external.code}|
instead of |\RequirePackage{external}| we minimize the compilation
time.
When there are a large number of standalone files, this difference can
amount to a significant amount of time.

If you wanted to reuse compiled results between compilations of the
master \LaTeX\ file, you would want to manually run the following
command.

\begin{tcolorbox}
\begin{verbatim}
pdflatex -shell-escape example-standalone-simple.tex
\end{verbatim}
\end{tcolorbox}

Then you would omit the call to \cs{ExternalCompile} and just call
\cs{ExternalRead} as in the following.

\begin{tcblisting}{}
\sz\ExternalRead[file=example-standalone-simple]\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Issues and Workarounds}
\label{sec:Issues and Workarounds}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Render not updating}
\label{subsec:Render not updating}

A common issue is when you change the \LaTeX\ code to be externally
rendered (e.g., the \meta{body} of a \cs{external}), but those changes
are not reflected in the master document after re-compiling the master
document.
The cause of this is that \pkg{external} has no way to detect whether
compiling the intermediate \LaTeX\ file succeeded or failed.
This failure can happen for example if the \LaTeX\ code to be
externally rendered contains an error that causes the compilation of
the intermediate \LaTeX\ file to fail.
If compilation of the intermediate \LaTeX\ file fails, the dimension
file and PDF file from previous compilation will not be overwritten.

To fix this, delete the PDF and dimension files.
Then failure of the compilation of the intermediate \LaTeX\ file will
cause a file-not-found error when the PDF and dimension file are read.
You can then fix the error in the \LaTeX\ code to be externally
rendered and use this file-not-found error to let you know when you
have fixed that \LaTeX\ code.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Hashes and command arguments}
\label{subsec:Hashes}

The use of hashes that one would use when referencing a command
argument (e.g., |#1|) can lead to problems.
For example, the following would lead to an error.

\begin{tcolorbox}
\begin{verbatim}
\sz\external[preamble={\newcommand{\p}[1]{(#1)}}]{\p{x}}\sz
\end{verbatim}
\end{tcolorbox}

The solution to this is to use double hashes (for example, |##1|
instead of |#1|) as demonstrated in the following.

\begin{tcblisting}{}
\sz\external[preamble={\newcommand{\p}[1]{(##1)}}]{\p{x}}\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz
\begin{externalenv}[preamble={\newcommand{\p}[1]{(##1)}}]
  \p{x}
\end{externalenv}
\sz
\end{tcblisting}

This even applies in the body of an \cs{external} or \env{externalenv}
as seen in the following.

\begin{tcblisting}{}
\sz\external{\newcommand{\p}[1]{(##1)}\p{x}}\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz
\begin{externalenv}
  \newcommand{\p}[1]{(##1)}%
  \p{x}
\end{externalenv}
\sz
\end{tcblisting}

This also applies to standalone files as seen in the following.

\showfile{example-standalone-hash.tex}

\begin{tcblisting}{}
\sz\ExternalCompile[file=example-standalone-hash]\sz~%
\sz\ExternalRead[file=example-standalone-hash]\sz
\end{tcblisting}

Finally, \cs{newexternal} and \cs{newexternalenv} require \textit{four}
hashes due to an extra level of indirection occurring in them as
demonstrated in the following examples.

\begin{tcblisting}{}
\sz\newexternal[preamble={\newcommand{\p}[1]{(####1)}}]{\paren}\sz~%
\sz\paren{\p{x}}\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz\newexternalenv[preamble={\newcommand{\p}[1]{(####1)}}]{paren}\sz~%
\sz\begin{paren}\p{x}\end{paren}\sz
\end{tcblisting}

However, in their bodies this does not apply and only two hashes should be used
as demonstrated in the following.

\begin{tcblisting}{}
\sz\newexternal{\paren}\sz~%
\sz\paren{\newcommand{\parens}[1]{(##1)}\parens{x}}\sz
\end{tcblisting}

\begin{tcblisting}{}
\sz\newexternalenv{paren}\sz~%
\sz
\begin{paren}
  \newcommand{\parens}[1]{(##1)}%
  \parens{x}
\end{paren}
\sz
\end{tcblisting}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Category codes}
\label{subsec:Catcodes}

Some commands change the category codes of many characters.
These pose a problem for use with commands from this \pkg{external}
package as the arguments to commands are parsed before those category
codes have changed.
The way to work around this is to use the \cs{scantokens} macro to
cause parts of those arguments to be re-parsed.

For example, the \cs{DeclareFontShape} macro redefines category codes
for characters used in its argument.
Thus to use it one must insert a call to \cs{scantokens} as in the
following.

\begin{tcblisting}{}
\sz
\external[preamble={
            \DeclareFontFamily{U}{msa}{}
            \scantokens{\DeclareFontShape{U}{msa}{m}{n}
              {<-6>msam5<6-8>msam7<8->msam10}{}\relax}
            \usepackage{pifont}}]
  {\Pisymbol{msa}{15}}%
\sz
\end{tcblisting}

The \cs{relax} before the end of the argument to \cs{scantokens}
ensures that \cs{scantokens} does not insert an extra space at the end.
See
\url{https://tex.stackexchange.com/questions/117906/use-of-everyeof-and-endlinechar-with-scantokens}
for details.

This trick also works when using a standalone file as in the following.

\showfile{example-standalone-catcode.tex}

\begin{tcblisting}{}
\sz\ExternalCompile[file=example-standalone-catcode]\sz~%
\sz\ExternalRead[file=example-standalone-catcode]\sz
\end{tcblisting}

\end{document}
