\documentclass[10pt]{ltxdoc}

\usepackage{external}

\usepackage{tcolorbox}
\tcbuselibrary{listings}
% TODO: center listings?

\newcommand{\showfile}[1]{
  \begin{tcolorbox}[title=\texttt{#1}]
  \verbatiminput{#1}
  \end{tcolorbox}
}

% TODO: registration mark
\def\gauge{%
  \rule{0.2em}{7pt}%
  \llap{\rule[8pt]{0.2em}{2pt}}%
}

\begin{document}

\title{The |external| package}
\author{Michael D. Adams\\\url{https://michaeldadams.org}}
\date{2019/01/15 v0.1}
\maketitle

\begin{abstract}
This package allows you to include the result of rendering LaTeX code
in a separate document.
This is useful when you want to use symbols from a package that you do
not want to load into your main document.
For example your main document may use symbols from multiple packages
that conflict or otherwise cannot be loaded together.
\end{abstract}

\section{Introduction}

This package allows you to include the result of rendering LaTeX code
in a separate document.
For example, you may want to use symbols from multiple packages that
cannot be loaded at the same time.
By rendering them in separate documents and then including their
rendered results in a master document, this allows you to render the
symbols from each part in their own package.

\subsection{Quick Start}

Suppose you want to use the |\textbeta| symbol from the |textgreek|
package, but you do do not want to load the |textgreek| package into
your master document.
(Maybe it is incompatible with some other package that you use or maybe
LaTeX has run out of space for declaring new fonts.)
You can simply render the |\textbeta| using the \cs{external} command
as in the following.

\begin{tcblisting}{}
An atom undergoing
\external[preamble={\usepackage{textgreek}}]{\textbeta-decay}
can emit an electron.
\end{tcblisting}

\begin{tcblisting}{}
An atom undergoing
\begin{externalenv}[preamble={\usepackage{textgreek}}]
\textbeta-decay
\end{externalenv}
~can emit an electron.
\end{tcblisting}

TODO: Temporary files of the form ... are generated.
You can explicitly specify the basename for this file with the
`file` option.

\begin{tcblisting}{}
An atom undergoing
\external[file=example-inline-greek,
  preamble={\usepackage{textgreek}}]
  {\textbeta-decay}
can emit an electron.
\end{tcblisting}

The |file| option specifies the name of the LaTeX file to which
\cs{external} should write the code, and the |preamble| option
specifies what code should be placed in the preamble of that file.

Note that even though this is rendered as a separate document, it is
properly spaced relative to the surrounding text as though it was
inline.
In the resulting PDF, this even behaves properly with regard to
copy-and-paste.

\subsection{Notation}

For debugging purposes, this documentation surrounds most examples with
a |\gauge| macro.
This makes it easy to see whether there is extra space to the left or
right of a symbol and whether parts of the symbol extend below the
baseline.
The bottom bar starts at the baseline and goes up 7 points.
The top bar starts at 8 points above the baseline and extends up to 10
points.
For example we might see something like the following.
Note that the top of the ``M'' is at 7 points above the baseline
even though the font size is 10 points.

\begin{tcblisting}{}
\gauge M\gauge
\end{tcblisting}

\section{Simple Usage}

The common use case is quite simple.
You just call \cs{external}\oarg{options}\marg{body}
where \meta{filename} ...

\begin{tcblisting}{}
\gauge
\external[preamble={\usepackage{amsmath}}]
  {$\iint xy\,dx\,dy$}%
\gauge
\end{tcblisting}

NOTE: If you want to include display math in \cs{external} use the incantation: |\[ \external{$\displaystyle...$} \]|

\begin{tcblisting}{}
\[
\gauge
\external[preamble={\usepackage{amsmath}}]
         {$\displaystyle\iint xy\,dx\,dy$}%
\gauge
\]
\end{tcblisting}

\begin{tcblisting}{}
\gauge
\external[preamble={\usepackage{amsmath}},math=true]
         {\iint xy\,dx\,dy}%
\gauge
\end{tcblisting}

\begin{tcblisting}{}
\gauge
\external[preamble={\usepackage{amsmath}},math=false]
         {$\iint xy\,dx\,dy$}%
\gauge
\end{tcblisting}

\begin{tcblisting}{}
\gauge
\external[preamble={\usepackage{amsmath}},math=inline]
         {\iint xy\,dx\,dy}%
\gauge
\end{tcblisting}

\begin{tcblisting}{}
\gauge
\external[preamble={\usepackage{amsmath}},math=display]
         {\iint xy\,dx\,dy}%
\gauge
\end{tcblisting}

TODO: error tests.  Maybe in directory and can use relative directory to use package?

% TODO: show example using \setkey{external}{file=...}

TODO: options can be set in package import

TODO: weave ``separate commands'' to test earlier?

\section{Separate Commands}

First two are blank

\begin{tcblisting}{}
\gauge
\ExternalWrite[file=example-inline-separate,preamble={\usepackage{amsmath}}]
  {$\iint xy\,dx\,dy$}%
\gauge

\gauge\ExternalRun[file=example-inline-separate]\gauge

\gauge\ExternalRead[file=example-inline-separate]\gauge
\end{tcblisting}

\section{Standalone Source Files}

First is blank

\showfile{example-standalone-simple.tex}

Note: be careful if you rename such a file, as you will also want to change the argument to \cs{ExternalCode}.

\begin{tcblisting}{}
\gauge\ExternalRun[file=example-standalone-simple]\gauge

\gauge\ExternalRead[file=example-standalone-simple]\gauge
\end{tcblisting}

\section{New}

Both \cs{external} and |externalenv| have ``new'' forms ... TODO

TODO: newcounter

\newcounter{external}

\makeatletter
\theexternal@number
\makeatother

\typeout{*************}
\typeout{*************}
\typeout{*************}
\typeout{*************}

\begin{tcblisting}{}
\newexternal[preamble={\usepackage{amsmath}}]{\ams}

\gauge\ams{$\iint xy\,dx\,dy$}\gauge

\gauge\ams{$\iiint xyz\,dx\,dy\,dz$}\gauge
\end{tcblisting}

\begin{tcblisting}{}
\newexternalenv[preamble={\usepackage{amsmath}}]{amsenv}

\gauge\begin{amsenv}
$\iint xy\,dx\,dy$
\end{amsenv}\gauge

\gauge\begin{amsenv}
$\iiint xyz\,dx\,dy\,dz$
\end{amsenv}\gauge

\gauge\begin{amsenv}[file=example-inline-amsenv] % TODO: [file=....]
$\iiiint xyzw\,dx\,dy\,dz\,dw$
\end{amsenv}\gauge
\end{tcblisting}

\section{Options}

TODO

TODO: `file` is fully expanded, if we don't want part of it expanded, include that in an `unexpanded` (still true?)

\section{Problems}

\subsection{Hashes}

Known problem: |#1|
Known workaround: |##1|

\begin{tcblisting}{}
\external[preamble={\def\parens##1{(##1)}}]
  {\parens{x}}
\end{tcblisting}

Note double hash if standalone

\showfile{example-standalone-hash.tex}

\begin{tcblisting}{}
\ExternalRun[file=example-standalone-hash]
\ExternalRead[file=example-standalone-hash]
\end{tcblisting}

\subsection{Catcodes}

Suppose you want to manually |\vDash| (\external[preamble={\usepackage{amssymb}}]{$\vDash$})

Known problem: catcode in body (e.g., |\DeclareFont|, etc.)
Known workarounds: |\scantokens|

We use |\scantokens| because |\DeclareFontShape| plays with the
catcodes and this code is being passed as the argument of another
command.

The |\relax| at the end ensures that |\scantokens| does not
insert an extra space at the end.
See https://tex.stackexchange.com/questions/117906/use-of-everyeof-and-endlinechar-with-scantokens

\begin{tcblisting}{}
\gauge
\external[preamble={
    \DeclareFontFamily{U}{msa}{}
      \scantokens{\DeclareFontShape{U}{msa}{m}{n}
        {<-6>msam5<6-8>msam7<8->msam10}{}\relax}
      \usepackage{pifont}}]
  {\Pisymbol{msa}{15}}%
\gauge
\end{tcblisting}

\showfile{example-standalone-catcode.tex}

\begin{tcblisting}{}
\gauge\ExternalRun[file=example-standalone-catcode]\gauge

\gauge\ExternalRead[file=example-standalone-catcode]\gauge
\end{tcblisting}

TODO: error tests

ExternalWrite:
  no file specified
  bad ``math'' flag
  warning: output file

ExternalRun:
  no file specified
  no shell escape
  restricted shell-escape
  TeX does not exist
  warning: no PDF file
  warning: no dim file

ExternalRead:
  bad ``math'' flag
  no input PDF file specified
  PDF does not exist
  dim file does not exist

TODO: rename compile to run



\end{document}
