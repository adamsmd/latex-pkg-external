\documentclass{ltxdoc}

\usepackage{external}

\usepackage{tcolorbox}
\tcbuselibrary{listingsutf8}
%\tcbset{sidebyside=true}

\newcommand{\showfile}[1]{
  \begin{tcolorbox}[title=\texttt{#1}]
  \verbatiminput{#1}
  \end{tcolorbox}
}

\def\GAGE{\rule{0.2em}{7pt}\llap{\rule[8pt]{0.2em}{2pt}}}

\begin{document}

\title{TODO: Title}
\author{TODO: Author}
\maketitle

\begin{abstract}
TODO: Abstract
\end{abstract}

\section{Introduction}

We use |\iint| which is |amsmath| only but we do not load |\usepackage{amsmath}| in the master document.

\subsection{Notation}

This documentation surrounds each example with |\GAGE| to print a gauge
for measuring with height and width of that example.
The bottom bar starts at the baseline and goes up 7 points.
The top bar extends up to 10 points above the baseline.
For example we might see something like the following.

\begin{tcblisting}{}
\GAGE M\GAGE
\end{tcblisting}


%\typeout{***** \expandafter\the\csname external@TOP\endcsname}
%\externaltest{example-inline-test}{}{foo}
%\typeout{***** \expandafter\the\csname external@top\endcsname}

\section{Simple Usage}

The common use case is quite simple.
You just call \cmd{\external}\marg{filename}\marg{preamble}\marg{body}
where \meta{filename} ...

\begin{tcblisting}{}
\GAGE
\external[file=example-inline-simple]
  {\usepackage{amsmath}}
  {$\iint x$}%
\GAGE
\end{tcblisting}

-------------

--------------

NOTE: If you want to include display math in \cmd{\external} use the incantation: |\[ \external{$\displaystyle...$} \]|

\begin{tcblisting}{}
\[
\GAGE
\external[file=example-inline-display]
  {\usepackage{amsmath}}
  {$\displaystyle\iint x$}%
\GAGE
\]
\end{tcblisting}

\section{Separate Commands}

First two are blank

\begin{tcblisting}{}
\GAGE
\ExternalWrite[file=example-inline-separate,top=2in]
  {\usepackage{amsmath}}
  {$\iint$}%
\GAGE

\GAGE\ExternalRun[file=example-inline-separate]\GAGE

\GAGE\ExternalRead[file=example-inline-separate]\GAGE
\end{tcblisting}

\section{Standalone Source Files}

First is blank

\showfile{example-standalone-simple.tex}

Note: be careful if you rename such a file, as you will also want to change the argument to \cmd{ExternalCode}.

\begin{tcblisting}{}
\GAGE\ExternalRun[file=example-standalone-simple]\GAGE

\GAGE\ExternalRead[file=example-standalone-simple]\GAGE
\end{tcblisting}

\section{New}

TODO:
\newcounter{external}[table]

\begin{tcblisting}{}
\newexternal{\ext}{\stepcounter{external}}{\usepackage{amsmath}}

\GAGE\ext{example-inline-new-\arabic{external}}{$\iint$}\GAGE

\GAGE\ext{example-inline-new-\arabic{external}}{$\iiint$}\GAGE
\end{tcblisting}

\begin{tcblisting}{}
\newexternal*{\extS}{\stepcounter{external}}
  {example-inline-new-\arabic{external}}
  {\usepackage{amsmath}}

\GAGE\extS{$\iint$}\GAGE

\GAGE\extS{$\iiint$}\GAGE
\end{tcblisting}

\section{Problems}

\subsection{Hashes}

Known problem: |#1|
Known workaround: |##1|

\begin{tcblisting}{}
\external[file=example-inline-hash]
  {\def\parens#1{(#1)}}
  {\parens{x}}
\end{tcblisting}

Note double hash if standalone

\showfile{example-standalone-hash.tex}

\begin{tcblisting}{}
\ExternalRun[file=example-standalone-hash]
\ExternalRead[file=example-standalone-hash]
\end{tcblisting}

\subsection{Catcodes}

Suppose you want to manually |\vDash| (\external[file=example-inline-vdash]{\usepackage{amssymb}}{$\vDash$})

Known problem: catcode in body (e.g., |\DeclareFont|, etc.)
Known workarounds: |\scantokens|

We use |\scantokens| because |\DeclareFontShape| plays with the
catcodes and this code is being passed as the argument of another
command.

The |\relax| at the end ensures that |\scantokens| does not
insert an extra space at the end.
See https://tex.stackexchange.com/questions/117906/use-of-everyeof-and-endlinechar-with-scantokens

\begin{tcblisting}{}
\GAGE
\external[file=example-inline-catcode]
  {\DeclareFontFamily{U}{msa}{}
   \scantokens{\DeclareFontShape{U}{msa}{m}{n}
     {<-6>msam5<6-8>msam7<8->msam10}{}\relax}
   \usepackage{pifont}}
  {\Pisymbol{msa}{15}}%
\GAGE
\end{tcblisting}

\showfile{example-standalone-catcode.tex}

\begin{tcblisting}{}
\GAGE\ExternalRun[file=example-standalone-catcode]\GAGE

\GAGE\ExternalRead[file=example-standalone-catcode]\GAGE
\end{tcblisting}

\end{document}
