\documentclass{article}

%\usepackage{graphicx}
%
%\makeatletter
%
%\newlength{\external@top}
%\newlength{\external@bottom}
%\newlength{\external@left}
%\newlength{\external@right}
%\newlength{\external@wd}
%\newlength{\external@ht}
%\newlength{\external@dp}
%
%% ARGS: filename preamble body
%\newcommand{\external}[3]{%
%  % Write to file
%  \newwrite\external@file
%  \immediate\openout\external@file=#1.tex%
%  \immediate\write\external@file{\unexpanded{
%    \documentclass{article}
%    #2
%    \begin{document}
%
%    \makeatletter
%
%    % Save the symbols into the box \external@box
%    \newsavebox{\external@box}
%    \savebox{\external@box}{#3}
%
%    % For the sake of debugging, print the dimentions of the symbol in \external@box
%    \typeout{*** width=\the\wd\external@box, height=\the\ht\external@box, depth=\the\dp\external@box}
%
%    % Save the dimentions of the symbol in \external@box
%    \newwrite\dimfile
%    \immediate\openout\dimfile=#1.dim
%    % TODO: save margins
%    \newlength{\external@top}
%    \newlength{\external@bottom}
%    \newlength{\external@left}
%    \newlength{\external@right}
%    \newlength{\external@wd}
%    \newlength{\external@ht}
%    \newlength{\external@dp}
%    \immediate\write\dimfile{\noexpand\setlength{\external@top}{1in}\relax}
%    \immediate\write\dimfile{\noexpand\setlength{\external@bottom}{1in}\relax}
%    \immediate\write\dimfile{\noexpand\setlength{\external@left}{1in}\relax}
%    \immediate\write\dimfile{\noexpand\setlength{\external@right}{1in}\relax}
%    \immediate\write\dimfile{\noexpand\setlength{\external@wd}{\the\wd\external@box}\relax}
%    \immediate\write\dimfile{\noexpand\setlength{\external@ht}{\the\ht\external@box}\relax}
%    \immediate\write\dimfile{\noexpand\setlength{\external@dp}{\the\dp\external@box}\relax}
%    \immediate\closeout\dimfile
%
%    % Set the text area to perfectly fit the symbol stored in \external@box,
%    % and set the page to have a one inch margin around the symbol.
%
%    \pagestyle{empty}
%
%    \setlength{\parindent}{0pt}
%    \setlength{\parskip}{0pt}
%    \renewcommand{\baselinestretch}{1.0}
%
%    \hoffset=0pt % NOTE: includes +1in offset
%    \voffset=0pt % NOTE: includes +1in offset
%    \topmargin=0pt
%    \headheight=0pt
%    \headsep=0pt
%    \marginparsep=0pt
%    \marginparwidth=0pt
%    \footskip=0pt
%    \marginparpush=0pt
%    \oddsidemargin=0pt
%    \evensidemargin=0pt
%    \topskip=0pt
%
%    \ifdefined\pdfpagewidth
%    \pdfpagewidth=\dimexpr\wd\external@box+2in
%    \pdfpageheight=\dimexpr\ht\external@box+\dp\external@box+2in
%    \else
%    \pagewidth=\dimexpr\wd\external@box+2in
%    \pageheight=\dimexpr\ht\external@box+\dp\external@box+2in
%    \fi
%    \paperwidth=\dimexpr\wd\external@box+2in
%    \paperheight=\dimexpr\ht\external@box+\dp\external@box+2in
%
%    \textwidth=\wd\external@box               % TODO: alignment problem
%    \textheight=\dimexpr\ht\external@box+\dp\external@box
%    \hsize=\wd\external@box                   % Paragraph width
%    \vsize=\dimexpr\ht\external@box+\dp\external@box % Column height
%
%    % Finally, render the \external@box
%    \usebox{\external@box}
%
%    \end{document}
%  }}%
%  \immediate\closeout\external@file
%  % Compile file
%  \immediate\write18{pdflatex -shell-escape -halt-on-error -interaction=batchmode #1.tex}%
%  % Load the dimentions of the symbol
%  \makeatletter
%  \input{#1.dim}%
%  \makeatother
%  % Include graphics
%  % Use \raisebox to model the symbol's depth
%  \raisebox{-\external@dp}{%
%    % We keep a one inch margin (that we then trim)
%    % to allow symbols to draw outsize their box
%    %
%    % Due to trouble with including a space after a command, we cannot use:
%    %   \includegraphics[trim=\the\external@left \the\external@bottom \the\external@right \the\external@top]{#1.pdf}
%    % So, instead we indirect through another command
%    \external@includegraphics{\the\external@left}{\the\external@bottom}{\the\external@right}{\the\external@top}{#1.pdf}}}
%
%\newcommand{\external@includegraphics}[5]{\includegraphics[trim=#1 #2 #3 #4]{#5}}
%
%\makeatother

\usepackage{external}

\begin{document}

%\externalWrite{file}{\usepackage{amsmath}}{$\int$}
%\externalRun{file}
%\externalRead{file}

%\foo@bar

This is a test M\external{file}{\usepackage{amsmath}}{$\int$}M and something after.


\end{document}

%\usepackage{graphics}
%\usepackage{tikz}
%\usetikzlibrary{external}
%\tikzexternalize
%\begin{document}
%In the following figure, we see a circle:
%%\beginpgfgraphicnamed{survey-f1}
%\begin{tikzpicture}
%\fill (0,0) circle (10pt);
%\end{tikzpicture}
%%\endpgfgraphicnamed
%By comparison, in this figure we see a rectangle:
%%\beginpgfgraphicnamed{survey-f2}
%\begin{tikzpicture}
%\fill (0,0) rectangle (10pt,10pt);
%\end{tikzpicture}
%%\endpgfgraphicnamed
\end{document}
